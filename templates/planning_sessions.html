{% extends "base.html" %}

{% block content %}
  <section class="session-history-page session-audit-page">
    <header class="settings-header">
      <div class="settings-title">
        <h1>Session Audit</h1>
        <p class="muted">Review past planning sessions, resume work quickly, and open load reports (approved loads only).</p>
      </div>
      <div class="panel-actions">
        {% if is_admin %}
          <a class="btn-secondary btn-xs" href="{{ url_for('planning_sessions_replay') }}">Replay Evaluation</a>
        {% endif %}
      </div>
    </header>

    {% if archived_session_id %}
      <div class="session-alert">
        Session #{{ archived_session_id }} archived. Its loads were released back to the order pool.
      </div>
    {% endif %}
    {% if archived_all_count is not none %}
      <div class="session-alert">
        Archived {{ archived_all_count }} session{% if archived_all_count != 1 %}s{% endif %} in the current filter set.
      </div>
    {% endif %}

    <div class="session-kpis">
      <div class="session-kpi-card">
        <div class="label">Total Sessions</div>
        <div class="value">{{ total_sessions }}</div>
      </div>
      <div class="session-kpi-card">
        <div class="label">Avg Efficiency</div>
        <div class="value">{{ avg_efficiency }}%</div>
      </div>
      <div class="session-kpi-card">
        <div class="label">Loads Optimized</div>
        <div class="value">{{ loads_optimized }}</div>
      </div>
      <div class="session-kpi-card">
        <div class="label">Active Session</div>
        <div class="value session-kpi-compact">{{ active_session_label or "--" }}</div>
      </div>
    </div>

    <form class="session-filters" method="get">
      <label class="inline-select">
        <span class="meta-label">Plant</span>
        <select name="plant">
          <option value="">All</option>
          {% for plant in plant_options %}
            <option value="{{ plant }}" {% if filters.plant == plant %}selected{% endif %}>{{ plant }}</option>
          {% endfor %}
        </select>
      </label>
      {% if can_manage_sessions %}
        <label class="inline-select">
          <span class="meta-label">Planner</span>
          <select name="planner">
            <option value="">All</option>
            {% for planner in planner_options %}
              <option value="{{ planner }}" {% if filters.planner == planner %}selected{% endif %}>{{ planner }}</option>
            {% endfor %}
          </select>
        </label>
      {% endif %}
      <label class="inline-select">
        <span class="meta-label">Start</span>
        <input class="select-field" type="date" name="start" value="{{ filters.start }}">
      </label>
      <label class="inline-select">
        <span class="meta-label">End</span>
        <input class="select-field" type="date" name="end" value="{{ filters.end }}">
      </label>
      <button class="btn-secondary btn-xs" type="submit">Apply</button>
    </form>

    <div class="session-toolbar">
      <div class="session-search">
        <span class="material-symbols-outlined">search</span>
        <input type="text" id="session-search-input" placeholder="Search sessions, planners, plants...">
      </div>
      <div class="session-toolbar-actions">
        <div class="session-toolbar-meta">All timestamps shown in ET.</div>
        <form
          method="post"
          action="{{ url_for('planning_sessions_archive_all') }}"
          onsubmit="return confirm('Archive all sessions in this filtered view and release their loads back to the order pool?');"
        >
          <input type="hidden" name="plant" value="{{ filters.plant }}">
          <input type="hidden" name="planner" value="{{ filters.planner }}">
          <input type="hidden" name="start" value="{{ filters.start }}">
          <input type="hidden" name="end" value="{{ filters.end }}">
          <button class="btn-warning btn-xs" type="submit">Archive All Filtered</button>
        </form>
      </div>
    </div>

    <div class="session-audit-grid">
      <div class="card-widget">
        <div class="panel-header">
          <div class="panel-title">
            <h3>Session History</h3>
          </div>
          <div class="meta-label">{{ sessions|length }} Records</div>
        </div>
        <div class="panel-body">
          <div class="table-container">
            <table class="session-table session-history-table">
              <thead>
                <tr>
                  <th>Session</th>
                  <th>Status</th>
                  <th>Executed (ET)</th>
                  <th>Loads</th>
                  <th>Avg Util</th>
                  <th>Orders</th>
                </tr>
              </thead>
              <tbody id="session-table-body">
                {% for session in sessions %}
                  {% set status_label = (session.status or 'DRAFT') | upper %}
                  <tr
                    class="session-row session-select-row{% if active_session_id and session.id == active_session_id %} is-active{% endif %}"
                    data-session-row="{{ session.id }}"
                    data-session-code="{{ session.session_code }}"
                    data-session-plant="{{ session.plant_code }}"
                    data-session-planner="{{ session.created_by or 'Planner' }}"
                    data-session-created="{{ session.created_at_label }}"
                    data-session-status="{{ status_label }}"
                    data-session-loads="{{ session.load_count or 0 }}"
                    data-session-orders="{{ session.order_count or 0 }}"
                    data-session-util="{{ (session.avg_utilization or 0) | round(1) }}"
                    data-summary-url="{{ url_for('planning_session_summary', session_id=session.id) }}"
                    data-resume-url="{{ url_for('planning_session_resume', session_id=session.id) }}"
                    data-report-url="{{ url_for('load_report', session_id=session.id) }}"
                    data-export-url="{{ url_for('load_report_export', session_id=session.id) }}"
                    data-archive-url="{{ url_for('planning_session_archive', session_id=session.id) }}"
                    tabindex="0"
                  >
                    <td>
                      <div class="session-line">
                        <strong>{{ session.session_code }}</strong>
                        {% if active_session_id and session.id == active_session_id %}
                          <span class="session-active-flag">Active</span>
                        {% endif %}
                      </div>
                      <div class="muted">{{ session.plant_code }} | {{ session.created_by or 'Planner' }}</div>
                    </td>
                    <td>
                      <span class="session-status-badge session-status-{{ status_label | lower }}">{{ status_label }}</span>
                    </td>
                    <td>{{ session.created_at_label }}</td>
                    <td>{{ session.load_count or 0 }}</td>
                    <td>{{ (session.avg_utilization or 0) | round(1) }}%</td>
                    <td>{{ session.order_count or 0 }}</td>
                  </tr>
                {% else %}
                  <tr>
                    <td colspan="6">No sessions found.</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="session-audit-right">
        <div class="card-widget session-preview-card">
          <div class="panel-header">
            <div class="panel-title">
              <div class="session-preview-title-row">
                <h3>Session Detail Preview</h3>
                <span class="muted" id="preview-subtitle">Select a session row to inspect details.</span>
              </div>
            </div>
            <div class="session-actions" id="preview-actions" hidden>
              <a class="btn-success btn-xs session-action-btn session-action-resume" id="preview-resume" href="#" hidden>
                <span class="material-symbols-outlined">play_arrow</span>
                Resume
              </a>
              <a class="btn-secondary btn-xs session-action-btn session-action-report" id="preview-report" href="#">
                <span class="material-symbols-outlined">description</span>
                Load Report
              </a>
              <a class="btn-ghost btn-xs session-action-btn session-action-export" id="preview-export" href="#">
                <span class="material-symbols-outlined">download</span>
                Export Excel
              </a>
              <form method="post" id="preview-archive-form" onsubmit="return confirm('Archive this session and release its loads back into the order pool?');">
                <input type="hidden" name="plant" value="{{ filters.plant }}">
                <input type="hidden" name="planner" value="{{ filters.planner }}">
                <input type="hidden" name="start" value="{{ filters.start }}">
                <input type="hidden" name="end" value="{{ filters.end }}">
                <button class="btn-warning btn-xs session-action-btn session-action-archive" type="submit">
                  <span class="material-symbols-outlined">archive</span>
                  Archive
                </button>
              </form>
            </div>
          </div>
          <div class="panel-body">
            <div id="preview-empty" class="session-alert">No session selected.</div>
            <div id="preview-content" class="hidden">
              <div class="session-meta-grid">
                <div class="session-meta-item">
                  <span class="meta-label">Session</span>
                  <strong id="preview-session-code">--</strong>
                </div>
                <div class="session-meta-item">
                  <span class="meta-label">Status</span>
                  <strong id="preview-status">--</strong>
                </div>
                <div class="session-meta-item">
                  <span class="meta-label">Plant</span>
                  <strong id="preview-plant">--</strong>
                </div>
                <div class="session-meta-item">
                  <span class="meta-label">Planner</span>
                  <strong id="preview-planner">--</strong>
                </div>
                <div class="session-meta-item session-meta-wide">
                  <span class="meta-label">Execution Time</span>
                  <strong id="preview-created">--</strong>
                </div>
              </div>
              <div class="session-preview-divider"></div>
              <div class="session-kpis session-preview-kpis">
                <div class="session-kpi-card">
                  <div class="label">Loads</div>
                  <div class="value" id="preview-loads">0</div>
                </div>
                <div class="session-kpi-card">
                  <div class="label">Orders</div>
                  <div class="value" id="preview-orders">0</div>
                </div>
                <div class="session-kpi-card">
                  <div class="label">Avg Util</div>
                  <div class="value" id="preview-util">0.0%</div>
                </div>
                <div class="session-kpi-card">
                  <div class="label">Estimated Cost</div>
                  <div class="value" id="preview-cost">$0</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card-widget">
          <div class="panel-header">
            <div class="panel-title">
              <h3>Included Loads</h3>
            </div>
          </div>
          <div class="panel-body">
            <div class="table-container">
              <table class="session-subtable">
                <thead>
                  <tr>
                    <th>Load #</th>
                    <th>Status</th>
                    <th>Trailer</th>
                    <th>Util</th>
                    <th>Orders</th>
                    <th>Stops</th>
                    <th>Miles</th>
                    <th>Cost</th>
                  </tr>
                </thead>
                <tbody id="preview-load-summary-body">
                  <tr><td colspan="8">Select a session to view included loads.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
    const sessionSearchInput = document.getElementById('session-search-input');
    const sessionRows = Array.from(document.querySelectorAll('[data-session-row]'));
    const summaryCache = new Map();

    function escapeHtml(value) {
      return String(value == null ? '' : value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatCurrency(value) {
      const num = Number(value || 0);
      return `$${num.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
    }

    function formatFloat(value, decimals = 1) {
      const num = Number(value || 0);
      return num.toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    }

    function setPreviewVisibility(show) {
      const empty = document.getElementById('preview-empty');
      const content = document.getElementById('preview-content');
      const actions = document.getElementById('preview-actions');
      if (empty) empty.classList.toggle('hidden', show);
      if (content) content.classList.toggle('hidden', !show);
      if (actions) actions.hidden = !show;
    }

    function setPreviewSummary(payload) {
      const loads = payload.loads || [];
      const loadBody = document.getElementById('preview-load-summary-body');
      const loadFallback = '<tr><td colspan="8">No loads in this session.</td></tr>';

      document.getElementById('preview-loads').textContent = String(payload.load_count || 0);
      document.getElementById('preview-orders').textContent = String(payload.order_count || 0);
      document.getElementById('preview-util').textContent = `${formatFloat(payload.avg_utilization || 0)}%`;
      document.getElementById('preview-cost').textContent = formatCurrency(payload.total_cost || 0);

      if (loadBody) {
        if (!loads.length) {
          loadBody.innerHTML = loadFallback;
        } else {
          const statusClass = (status) => {
            const token = String(status || '').toUpperCase();
            if (token === 'APPROVED') return 'approved';
            if (token === 'DRAFT') return 'draft';
            if (token === 'PROPOSED') return 'proposed';
            return 'neutral';
          };
          loadBody.innerHTML = loads.slice(0, 20).map((load) => `
            <tr>
              <td>${escapeHtml(load.load_number || '')}</td>
              <td><span class="session-load-status status-${statusClass(load.status)}">${escapeHtml(load.status || '')}</span></td>
              <td>${escapeHtml(load.trailer_type || '')}</td>
              <td>
                <div class="session-util-cell">
                  <div class="session-util-track">
                    <span class="session-util-fill" style="width:${Math.max(0, Math.min(Number(load.utilization_pct || 0), 100))}%;"></span>
                  </div>
                  <strong>${formatFloat(load.utilization_pct || 0)}%</strong>
                </div>
              </td>
              <td>${escapeHtml(load.order_count || 0)}</td>
              <td>${escapeHtml(load.stop_count || 0)}</td>
              <td>${formatFloat(load.estimated_miles || 0)}</td>
              <td>${formatCurrency(load.estimated_cost || 0)}</td>
            </tr>
          `).join('');
        }
      }
    }

    function updatePreviewButtons(row) {
      const status = String(row.dataset.sessionStatus || '').toUpperCase();
      const resumable = status === 'DRAFT';
      const reportBtn = document.getElementById('preview-report');
      const exportBtn = document.getElementById('preview-export');
      const resumeBtn = document.getElementById('preview-resume');
      const archiveForm = document.getElementById('preview-archive-form');

      resumeBtn.href = row.dataset.resumeUrl || '#';
      reportBtn.href = row.dataset.reportUrl || '#';
      exportBtn.href = row.dataset.exportUrl || '#';
      resumeBtn.hidden = !resumable;
      if (archiveForm) archiveForm.action = row.dataset.archiveUrl || '#';
    }

    async function loadSessionSummary(row) {
      const sessionId = row.dataset.sessionRow;
      if (!sessionId) return;
      if (summaryCache.has(sessionId)) {
        setPreviewSummary(summaryCache.get(sessionId));
        return;
      }
      const summaryUrl = row.dataset.summaryUrl || '';
      if (!summaryUrl) return;

      const response = await fetch(summaryUrl, { headers: { Accept: 'application/json' } });
      if (!response.ok) {
        throw new Error('Unable to load session details.');
      }
      const payload = await response.json();
      summaryCache.set(sessionId, payload);
      setPreviewSummary(payload);
    }

    async function selectSessionRow(row) {
      if (!row) return;
      sessionRows.forEach((entry) => entry.classList.remove('is-active'));
      row.classList.add('is-active');
      setPreviewVisibility(true);

      document.getElementById('preview-session-code').textContent = row.dataset.sessionCode || '--';
      document.getElementById('preview-status').textContent = row.dataset.sessionStatus || '--';
      document.getElementById('preview-plant').textContent = row.dataset.sessionPlant || '--';
      document.getElementById('preview-planner').textContent = row.dataset.sessionPlanner || '--';
      document.getElementById('preview-created').textContent = row.dataset.sessionCreated || '--';
      document.getElementById('preview-subtitle').textContent = `ID: ${row.dataset.sessionCode || '--'}`;
      updatePreviewButtons(row);

      document.getElementById('preview-loads').textContent = row.dataset.sessionLoads || '0';
      document.getElementById('preview-orders').textContent = row.dataset.sessionOrders || '0';
      document.getElementById('preview-util').textContent = `${row.dataset.sessionUtil || '0.0'}%`;
      document.getElementById('preview-cost').textContent = '$0';

      try {
        await loadSessionSummary(row);
      } catch (err) {
        const loadBody = document.getElementById('preview-load-summary-body');
        if (loadBody) loadBody.innerHTML = `<tr><td colspan="8">${escapeHtml(err.message || 'Unable to load details.')}</td></tr>`;
      }
    }

    function applySessionFilter() {
      const query = sessionSearchInput ? sessionSearchInput.value.trim().toLowerCase() : '';
      let firstVisible = null;
      sessionRows.forEach((row) => {
        const text = row.textContent.toLowerCase();
        const match = !query || text.includes(query);
        row.style.display = match ? '' : 'none';
        if (match && !firstVisible) firstVisible = row;
      });

      const selected = sessionRows.find((row) => row.classList.contains('is-active') && row.style.display !== 'none');
      if (!selected) {
        if (firstVisible) {
          selectSessionRow(firstVisible);
        } else {
          setPreviewVisibility(false);
        }
      }
    }

    sessionRows.forEach((row) => {
      row.addEventListener('click', () => selectSessionRow(row));
      row.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          selectSessionRow(row);
        }
      });
    });

    if (sessionSearchInput) {
      sessionSearchInput.addEventListener('input', applySessionFilter);
    }

    const initiallyActive = sessionRows.find((row) => row.classList.contains('is-active')) || sessionRows[0];
    if (initiallyActive) {
      selectSessionRow(initiallyActive);
    } else {
      setPreviewVisibility(false);
    }
  </script>
{% endblock %}
