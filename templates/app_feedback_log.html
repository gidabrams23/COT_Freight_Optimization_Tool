{% extends "base.html" %}

{% block content %}
  <section class="feedback-log-page">
    <div class="page-header">
      <div>
        <h1>Feedback Log</h1>
        <p>Track app feedback submissions from the sidebar form.</p>
      </div>
    </div>

    <div class="feedback-log-tabs">
      <a class="feedback-log-tab" href="{{ url_for('feedback_log') }}">Load Feedback</a>
      <a class="feedback-log-tab active" href="{{ url_for('app_feedback_log') }}">App Feedback</a>
    </div>

    <div class="card-widget">
      <form class="table-filters feedback-filters" method="get">
        <div class="inline-select">
          <label class="metric-label">Start</label>
          <input class="select-field" type="date" name="start_date" value="{{ filters.start_date }}">
        </div>
        <div class="inline-select">
          <label class="metric-label">End</label>
          <input class="select-field" type="date" name="end_date" value="{{ filters.end_date }}">
        </div>
        <div class="inline-select">
          <label class="metric-label">Planner</label>
          <select class="select-field" name="planner_id">
            <option value="">All</option>
            {% for planner in options.planners %}
              <option value="{{ planner }}" {% if planner == filters.planner_id %}selected{% endif %}>{{ planner | title }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="inline-select">
          <label class="metric-label">Type</label>
          <select class="select-field" name="category">
            <option value="">All</option>
            {% for category in options.categories %}
              <option value="{{ category }}" {% if category == filters.category %}selected{% endif %}>{{ category }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="inline-select">
          <label class="metric-label">Status</label>
          <select class="select-field" name="status">
            <option value="">All</option>
            {% for status in options.statuses %}
              <option value="{{ status }}" {% if status == filters.status %}selected{% endif %}>{{ status }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="inline-select feedback-search">
          <label class="metric-label">Search</label>
          <input class="select-field" type="text" name="search" value="{{ filters.search }}" placeholder="Search feedback or page">
        </div>
        <div class="inline-select">
          <label class="metric-label">Sort</label>
          <select class="select-field" name="sort">
            <option value="timestamp_desc" {% if filters.sort == 'timestamp_desc' %}selected{% endif %}>Newest</option>
            <option value="timestamp_asc" {% if filters.sort == 'timestamp_asc' %}selected{% endif %}>Oldest</option>
            <option value="planner" {% if filters.sort == 'planner' %}selected{% endif %}>Planner</option>
            <option value="status" {% if filters.sort == 'status' %}selected{% endif %}>Status</option>
          </select>
        </div>
        <div class="filter-actions">
          <button class="btn-primary btn-xs" type="submit">Apply</button>
          <a class="btn-ghost btn-xs" href="{{ url_for('app_feedback_log') }}">Clear</a>
        </div>
      </form>

      <div class="table-container">
        <table class="data-table feedback-table">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th>Planner</th>
              <th>Type</th>
              <th>Page</th>
              <th>Title</th>
              <th>Feedback</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% if entries %}
              {% for entry in entries %}
                <tr>
                  <td>{{ entry.created_at | est_datetime }}</td>
                  <td>{{ (entry.planner_id or "Unknown") | title }}</td>
                  <td>{{ entry.category }}</td>
                  <td>{{ entry.page or "-" }}</td>
                  <td>{{ entry.title }}</td>
                  <td>{{ entry.message }}</td>
                  <td>
                    <span class="status-pill{% if entry.status == 'RESOLVED' %} status-pill-muted{% endif %}">
                      {{ entry.status }}
                    </span>
                  </td>
                  <td>
                    {% if entry.status != 'RESOLVED' %}
                      <form method="post" action="{{ url_for('resolve_app_feedback', feedback_id=entry.id) }}">
                        <input type="hidden" name="next" value="{{ request.full_path }}">
                        <button class="btn-success btn-xs" type="submit">Resolve</button>
                      </form>
                    {% else %}
                      <span class="muted">Resolved</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="8" class="muted">No app feedback entries yet.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </section>
{% endblock %}
