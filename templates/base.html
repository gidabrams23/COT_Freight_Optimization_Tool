<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>COT Freight Optimization Tool v1</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  </head>
  <body class="{% if show_nav is defined and not show_nav %}no-nav{% endif %}">
    <div class="app-shell{% if show_nav is defined and not show_nav %} shell-no-nav{% endif %}">
      {% if show_nav is not defined or show_nav %}
        <aside class="sidebar" data-sidebar>
          <div class="sidebar-header">
            <div class="sidebar-brand">
              <div class="sidebar-logo-wrap primary">
                <img class="sidebar-logo primary" src="{{ url_for('static', filename='images/cot-logo.png') }}" alt="Carry-On Trailer">
              </div>
            </div>
            <button class="sidebar-toggle" type="button" data-sidebar-toggle aria-label="Toggle sidebar">
              <span class="material-symbols-outlined">menu_open</span>
            </button>
          </div>
          <nav class="sidebar-nav">
            <div class="nav-section">
              <div class="nav-section-label">Planning</div>
              <a class="nav-item{% if request.path.startswith('/dashboard') or request.path == '/' %} active{% endif %}" href="{{ url_for('dashboard') }}">
                <span class="material-symbols-outlined nav-icon">dashboard</span>
                <span class="nav-text">Dashboard</span>
              </a>
              <a class="nav-item{% if request.path.startswith('/orders') %} active{% endif %}" href="{{ url_for('orders') }}">
                <span class="material-symbols-outlined nav-icon">list_alt</span>
                <span class="nav-text">Orders</span>
              </a>
              <a class="nav-item{% if request.path.startswith('/loads') %} active{% endif %}" href="{{ url_for('loads') }}">
                <span class="material-symbols-outlined nav-icon">local_shipping</span>
                <span class="nav-text">Loads</span>
              </a>
            </div>
            <div class="nav-section">
              <div class="nav-section-label">ADMIN</div>
              {% if is_admin %}
                <a class="nav-item{% if request.path.startswith('/planning-sessions') and not request.path.startswith('/planning-sessions/replay') %} active{% endif %}" href="{{ url_for('planning_sessions') }}">
                  <span class="material-symbols-outlined nav-icon">history</span>
                  <span class="nav-text">Session History</span>
                </a>
                <a class="nav-item{% if request.path.startswith('/planning-sessions/replay') %} active{% endif %}" href="{{ url_for('planning_sessions_replay') }}">
                  <span class="material-symbols-outlined nav-icon">query_stats</span>
                  <span class="nav-text">Replay Eval</span>
                </a>
              {% endif %}
              <a class="nav-item{% if request.path.startswith('/feedback') %} active{% endif %}" href="{{ url_for('feedback_log') }}">
                <span class="material-symbols-outlined nav-icon">comment</span>
                <span class="nav-text">Feedback Log</span>
              </a>
              <a class="nav-item{% if request.path.startswith('/settings') %} active{% endif %}" href="{{ url_for('settings') }}">
                <span class="material-symbols-outlined nav-icon">tune</span>
                <span class="nav-text">Settings</span>
              </a>
            </div>
          </nav>
          <div class="sidebar-feedback">
            <div class="sidebar-feedback-header">
              <span class="meta-label">App Feedback</span>
            </div>
            <button class="btn-primary btn-xs" type="button" data-feedback-open>Give Feedback</button>
          </div>
          <div class="sidebar-footer">
            {% if session_role %}
              {% set profile_display = session_profile_name or (session_role | title) %}
              {% set initials = profile_display[:1] | upper %}
              <details class="profile-menu">
                <summary class="profile-summary" aria-label="Open profile menu">
                  <div class="profile-card">
                    <div class="profile-avatar">{{ initials }}</div>
                    <div class="profile-meta">
                      <div class="profile-name">{{ profile_display }}</div>
                      <div class="profile-subtitle">{{ session_plant_filter_label }}</div>
                    </div>
                  </div>
                </summary>
                <div class="profile-menu-panel">
                  <form method="post" action="{{ url_for('access_switch') }}">
                    <input type="hidden" name="next" value="{{ request.full_path.rstrip('?') }}">
                    <label class="profile-menu-label">
                      Profile
                      <select name="profile_id" onchange="this.form.submit()">
                        {% for profile in access_profiles %}
                          <option value="{{ profile.id }}" {% if session_profile_id == profile.id %}selected{% endif %}>
                            {{ profile.name }}
                          </option>
                        {% endfor %}
                      </select>
                    </label>
                  </form>
                  {% if is_admin %}
                    <a class="profile-menu-link" href="{{ url_for('access_manage') }}">Manage Profiles</a>
                  {% endif %}
                  <a class="profile-menu-link" href="{{ url_for('login') }}">Switch Account</a>
                  <form method="get" action="{{ url_for('session_reset') }}">
                    <button class="profile-menu-link" type="submit">Reset Session</button>
                  </form>
                </div>
              </details>
            {% else %}
              <a class="nav-item" href="{{ url_for('login') }}">
                <span class="material-symbols-outlined nav-icon">person</span>
                <span class="nav-text">Sign In</span>
              </a>
            {% endif %}
            <div class="sidebar-brand secondary">
              <div class="sidebar-logo-wrap secondary">
                <img class="sidebar-logo secondary" src="{{ url_for('static', filename='images/ssa-logo.png') }}" alt="SSA & Company">
              </div>
            </div>
          </div>
        </aside>
      {% endif %}
      <div class="app-main">
        <main class="page{% if request.path.startswith('/orders') or request.path.startswith('/loads') or request.path.startswith('/dashboard') or request.path == '/' or request.path.startswith('/settings') %} page-full{% endif %}{% if request.path == '/loads' %} page-loads-index{% endif %}">
          {% block content %}{% endblock %}
        </main>
      </div>
    </div>
    <div class="modal-backdrop hidden" id="app-feedback-modal" data-feedback-modal>
      <div class="modal-card">
        <div class="modal-header">
          <div class="modal-title">
            <h3>App Feedback</h3>
            <p>Pick a type and tell us what you need.</p>
          </div>
          <button class="btn-icon" type="button" data-feedback-close aria-label="Close app feedback">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <form method="post" action="{{ url_for('submit_app_feedback') }}" class="modal-body" data-feedback-form>
          <input type="hidden" name="category" id="feedback-category" required>
          <input type="hidden" name="page" value="{{ request.path }}">
          <input type="hidden" name="next" value="{{ request.full_path }}">

          <div class="feedback-type-grid" data-feedback-types>
            <button class="feedback-type-btn" type="button" data-type="Bug">
              <span class="material-symbols-outlined">bug_report</span>
              Bug
            </button>
            <button class="feedback-type-btn" type="button" data-type="Feature">
              <span class="material-symbols-outlined">lightbulb</span>
              Feature
            </button>
            <button class="feedback-type-btn" type="button" data-type="Other">
              <span class="material-symbols-outlined">forum</span>
              Other
            </button>
          </div>

          <label class="feedback-field">
            Title
            <input class="select-field" name="title" type="text" placeholder="Short summary" required>
          </label>
          <label class="feedback-field">
            Details
            <textarea class="select-field" name="message" rows="4" placeholder="Share details..." required></textarea>
          </label>
          <div class="modal-footer feedback-modal-footer">
            <button class="btn-primary" type="submit" data-feedback-submit disabled>Send Feedback</button>
          </div>
        </form>
      </div>
    </div>
    <script>
      const sidebarToggle = document.querySelector('[data-sidebar-toggle]');
      if (sidebarToggle) {
        const storageKey = 'sidebar-collapsed';
        const applyCollapsed = (collapsed) => {
          document.body.classList.toggle('sidebar-collapsed', collapsed);
        };
        const saved = localStorage.getItem(storageKey);
        if (saved === 'true') {
          applyCollapsed(true);
        }
        sidebarToggle.addEventListener('click', () => {
          const next = !document.body.classList.contains('sidebar-collapsed');
          applyCollapsed(next);
          localStorage.setItem(storageKey, next ? 'true' : 'false');
        });
      }

      const feedbackModal = document.getElementById('app-feedback-modal');
      const feedbackOpen = document.querySelector('[data-feedback-open]');
      const feedbackClose = feedbackModal ? feedbackModal.querySelector('[data-feedback-close]') : null;
      const feedbackForm = feedbackModal ? feedbackModal.querySelector('[data-feedback-form]') : null;
      const feedbackCategory = document.getElementById('feedback-category');
      const feedbackTypes = feedbackModal ? feedbackModal.querySelectorAll('[data-type]') : [];
      const feedbackSubmit = feedbackModal ? feedbackModal.querySelector('[data-feedback-submit]') : null;

      function openFeedbackModal() {
        if (!feedbackModal) return;
        feedbackModal.classList.remove('hidden');
      }

      function closeFeedbackModal() {
        if (!feedbackModal) return;
        feedbackModal.classList.add('hidden');
        if (feedbackForm) feedbackForm.reset();
        if (feedbackCategory) feedbackCategory.value = '';
        feedbackTypes.forEach((btn) => btn.classList.remove('active'));
        if (feedbackSubmit) feedbackSubmit.disabled = true;
      }

      if (feedbackOpen) feedbackOpen.addEventListener('click', openFeedbackModal);
      if (feedbackClose) feedbackClose.addEventListener('click', closeFeedbackModal);

      if (feedbackModal) {
        feedbackModal.addEventListener('click', (event) => {
          if (event.target === feedbackModal) closeFeedbackModal();
        });
      }

      document.addEventListener('keydown', (event) => {
        if (event.key !== 'Escape') return;
        if (!feedbackModal || feedbackModal.classList.contains('hidden')) return;
        closeFeedbackModal();
      });

      feedbackTypes.forEach((btn) => {
        btn.addEventListener('click', () => {
          const type = btn.dataset.type || '';
          feedbackTypes.forEach((item) => item.classList.remove('active'));
          btn.classList.add('active');
          if (feedbackCategory) feedbackCategory.value = type;
          if (feedbackSubmit) feedbackSubmit.disabled = !type;
        });
      });
    </script>
  </body>
</html>
