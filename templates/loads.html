{% extends "base.html" %}

{% block content %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <section class="loads-page" data-loads-tab="{{ tab }}">
    <header class="orders-header loads-header">
      <div class="loads-hero-row">
        <div class="loads-hero-title">
            <div class="loads-title-row">
              <div class="orders-title loads-title">
                <h1>Load Review Center</h1>
              </div>
            </div>
            <div class="loads-optimization-inline" aria-label="Optimization output">
              <div class="loads-optimization-metrics">
                <div class="loads-optimization-metric">
                  <span class="metric-label">Plants</span>
                  <span class="metric-value metric-value-muted">{% if plant_filter_param %}{{ plant_filter_param }}{% else %}All Plants{% endif %}</span>
                </div>
                <div class="loads-optimization-metric">
                  <span class="metric-label">Orders</span>
                  <span class="metric-value metric-value-primary" data-opt-total-orders>{{ optimization_summary.total_orders }}</span>
                </div>
                <div class="loads-optimization-metric">
                  <span class="metric-label">Avg Util</span>
                  <span class="metric-value metric-value-success" data-opt-avg-util>{{ optimization_summary.avg_utilization | round(1) }}%</span>
                </div>
                <div class="loads-optimization-metric">
                  <span class="metric-label">Est Spend</span>
                  <span class="metric-value metric-value-warning" data-opt-total-spend>${{ "{:,.0f}".format((optimization_summary.total_spend or 0) | float) }}</span>
                </div>
                <div class="loads-optimization-metric">
                  <span class="metric-label">Spend / Unit</span>
                  <span class="metric-value metric-value-muted metric-value-sub" data-opt-spend-unit>${{ "{:,.2f}".format((optimization_summary.spend_per_unit or 0) | float) }}</span>
                </div>
              </div>
            </div>
          </div>

        <div class="loads-hero-side">
          <div class="approval-tracker approval-tracker-compact" aria-label="Daily goal progress" data-approval-tracker>
            {% set progress_display = (progress_pct or 0) | round(0) %}
            {% set progress_width = progress_display %}
            {% if progress_width > 100 %}
              {% set progress_width = 100 %}
            {% elif progress_width < 0 %}
              {% set progress_width = 0 %}
            {% endif %}

            <div class="approval-tracker-head">
              <span class="tracker-label">Daily Goal Progress</span>
              <span class="tracker-label tracker-label-right">Approved</span>
            </div>

            <div class="approval-tracker-main">
              <div class="approval-tracker-left">
                <span class="approval-tracker-pct" data-approval-pct>{{ progress_display }}%</span>
              </div>

              <div
                class="approval-tracker-bar"
                data-approval-bar
                role="progressbar"
                aria-label="Approved orders progress"
                aria-valuemin="0"
                aria-valuemax="100"
                aria-valuenow="{{ progress_width }}"
              >
                <span class="approval-tracker-fill" data-approval-fill style="width: {{ progress_width }}%"></span>
              </div>

              <div class="approval-tracker-right">
                <span class="approval-tracker-count" data-approval-count>{{ approved_orders }} / {{ total_orders }} Orders</span>
              </div>
            </div>
          </div>
          <div class="loads-today-wrap">
            <button class="btn-secondary loads-today-toggle" type="button" data-today-toggle aria-expanded="false" aria-controls="loads-today-panel">
              <span class="material-symbols-outlined">event</span>
              Today
            </button>
            {% if today_override_label %}
              <div class="loads-today-meta">As of {{ today_override_label }}</div>
            {% endif %}
            <div class="loads-today-panel hidden" id="loads-today-panel" data-today-panel data-today-autoshow="false">
              <div class="form-grid">
                <label>
                  As Of Date
                  <input class="select-field" type="date" id="loads-today-input" value="{{ today_override_value }}">
                </label>
                <div class="form-actions">
                  <button class="btn-secondary" type="button" data-today-apply>Apply</button>
                  <button class="btn-ghost" type="button" data-today-clear>Use Real Today</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="card-widget loads-panel">
      {% if reopt_status == 'done' %}
        <div class="banner">Re-optimization complete.</div>
      {% endif %}

      {% if manual_error %}
        <div class="alert alert-error">{{ manual_error }}</div>
      {% endif %}

        {% set has_loads = loads and loads | length %}
          <div class="loads-review-layout" data-load-review-layout>
            <div class="loads-left-shell">
              <div class="loads-tabs-shell">
                  <div class="load-tabs">
                    <div class="load-tabs-left">
                      {% if plant_filter_param %}
                        <a class="load-tab{% if tab == 'draft' %} active{% endif %}" href="{{ url_for('loads', plants=plant_filter_param, tab='draft', sort=sort_mode, today=today_override_value or None) }}">
                          <span class="material-symbols-outlined">edit_document</span>
                          Draft Loads
                          <span class="tab-count warning" data-tab-count="draft">{{ draft_tab_count }}</span>
                        </a>
                        <a
                          class="load-tab{% if tab == 'final' %} active{% endif %}{% if final_tab_count == 0 %} disabled{% endif %}"
                          href="{{ url_for('loads', plants=plant_filter_param, tab='final', sort=sort_mode, today=today_override_value or None) }}"
                          {% if final_tab_count == 0 %}aria-disabled="true" tabindex="-1"{% endif %}
                        >
                          <span class="material-symbols-outlined">verified</span>
                          Finalize Loads
                          <span class="tab-count success" data-tab-count="final">{{ final_tab_count }}</span>
                        </a>
                      {% else %}
                        <a class="load-tab{% if tab == 'draft' %} active{% endif %}" href="{{ url_for('loads', tab='draft', sort=sort_mode, today=today_override_value or None) }}">
                          <span class="material-symbols-outlined">edit_document</span>
                          Draft Loads
                          <span class="tab-count warning" data-tab-count="draft">{{ draft_tab_count }}</span>
                        </a>
                        <a
                          class="load-tab{% if tab == 'final' %} active{% endif %}{% if final_tab_count == 0 %} disabled{% endif %}"
                          href="{{ url_for('loads', tab='final', sort=sort_mode, today=today_override_value or None) }}"
                          {% if final_tab_count == 0 %}aria-disabled="true" tabindex="-1"{% endif %}
                        >
                          <span class="material-symbols-outlined">verified</span>
                          Finalize Loads
                          <span class="tab-count success" data-tab-count="final">{{ final_tab_count }}</span>
                        </a>
                      {% endif %}
                    </div>
                    <div class="load-tabs-actions" aria-label="Bulk load actions">
                      <div class="loads-sort-wrap">
                        <button class="btn-secondary loads-sort-toggle" type="button" data-sort-toggle aria-expanded="false" aria-controls="loads-sort-panel">
                          <span class="material-symbols-outlined">sort</span>
                          Sort
                        </button>
                        <div class="loads-sort-panel hidden" id="loads-sort-panel" data-sort-panel>
                          <div class="loads-sort-options">
                            <a class="loads-sort-option{% if sort_mode == 'flow' %} active{% endif %}" href="{{ url_for('loads', plants=plant_filter_param or None, tab=tab or None, sort='flow', today=today_override_value or None) }}">
                              Flow
                            </a>
                            <a class="loads-sort-option{% if sort_mode == 'util' %} active{% endif %}" href="{{ url_for('loads', plants=plant_filter_param or None, tab=tab or None, sort='util', today=today_override_value or None) }}">
                              Util
                            </a>
                          </div>
                        </div>
                      </div>
                      {% if tab != 'final' %}
                        <form method="post" action="{{ url_for('approve_all_loads') }}">
                          <input type="hidden" name="plants" value="{{ plant_filter_param }}">
                          <input type="hidden" name="tab" value="{{ tab }}">
                          <input type="hidden" name="sort" value="{{ sort_mode }}">
                          {% if today_override_value %}
                            <input type="hidden" name="today" value="{{ today_override_value }}">
                          {% endif %}
                          <button class="btn-secondary btn-xs" type="submit">
                            <span class="material-symbols-outlined">done_all</span>
                            Accept All Draft Loads
                          </button>
                        </form>
                      {% endif %}
                    </div>
	                  </div>
	                </div>
	              <div class="loads-list-shell">
	                <div class="loads-shell-header loads-shell-header-left">
	                  <div class="loads-list-bar">
                    <div class="loads-list-actions">
                      {% if tab != 'final' %}
                        <button class="btn-secondary btn-xs" type="button" data-manual-load-open>
                          <span class="material-symbols-outlined">add_box</span>
                          Manual Load
                        </button>
                      {% endif %}
                      <form method="post" action="{{ url_for('clear_loads') }}" onsubmit="return confirm('Clear all loads for the current plant scope?');">
                        <input type="hidden" name="plants" value="{{ plant_filter_param }}">
                        <input type="hidden" name="tab" value="{{ tab }}">
                        <input type="hidden" name="sort" value="{{ sort_mode }}">
                        {% if today_override_value %}
                          <input type="hidden" name="today" value="{{ today_override_value }}">
                        {% endif %}
                        <button class="btn-danger btn-xs" type="submit">
                          <span class="material-symbols-outlined">delete_forever</span>
                          Clear Loads
                        </button>
                      </form>
                    </div>
                    <div class="search-field loads-search-field">
                      <span class="material-symbols-outlined">search</span>
                      <input type="text" placeholder="Search Load ID..." data-load-search-input aria-label="Search loads">
                    </div>
                  </div>
                </div>

                <div class="loads-master" data-load-review-master>
                  <div class="loads-grid-head" aria-hidden="true">
                    <div class="loads-grid-head-cell">Load / Route</div>
                    <div class="loads-grid-head-cell">Details</div>
                    <div class="loads-grid-head-cell">Utilization</div>
                    <div class="loads-grid-head-cell loads-grid-head-cell-right">Financials</div>
                  </div>
                  {% if has_loads %}
                    {% for section in load_sections %}
                      {% if section.loads %}
                        <div class="load-section" data-section="{{ section.kind }}">
                        <div class="load-section-title load-section-title-row">
                          <span>{{ section.title }}</span>
                          {% if tab == 'draft' and section.kind == 'full' %}
                            <form method="post" action="{{ url_for('approve_full_truckloads') }}">
                              <input type="hidden" name="plants" value="{{ plant_filter_param }}">
                              <input type="hidden" name="tab" value="{{ tab }}">
                              <input type="hidden" name="sort" value="{{ sort_mode }}">
                              {% if today_override_value %}
                                <input type="hidden" name="today" value="{{ today_override_value }}">
                              {% endif %}
                              <button class="btn-secondary btn-xs" type="submit">
                                <span class="material-symbols-outlined">done_all</span>
                                Accept All Full Truckload Loads
                              </button>
                            </form>
                          {% endif %}
                        </div>
                          <div class="loads-list">
                            {% for load in section.loads %}
                      {% set status = load.status or 'PROPOSED' %}
                      {% set panel_open = feedback_target.startswith('load-' ~ load.id) or feedback_target.startswith('order-' ~ load.id ~ '-') %}
                      {% set display_label = load.load_number if status == 'APPROVED' and load.load_number else 'Load #' ~ (load.draft_sequence if load.draft_sequence else load.id) %}
                      {% set util_value = (load.utilization_pct or 0) | round(0) %}
                      {% set util_width = 100 if util_value > 100 else util_value %}
                      {% set util_grade = (load.schematic.utilization_grade if load.schematic else 'F') %}
                      {% if util_value >= 80 %}
                        {% set util_class = 'success' %}
                      {% elif util_value >= 70 %}
                        {% set util_class = 'warning' %}
                      {% else %}
                        {% set util_class = 'danger' %}
                      {% endif %}
                      {% set miles = (load.route_distance if load.route_distance is not none else (load.estimated_miles or 0)) | round(0) %}
                      <div
                        class="load-row{% if panel_open %} selected{% endif %}"
                        data-load-id="{{ load.id }}"
                        data-load-label="{{ display_label }}"
                        {% if panel_open %}data-initial-selected="true"{% endif %}
                        data-load-grade="{{ util_grade }}"
                        data-load-orders="{{ load.order_count or 0 }}"
                        data-load-units="{{ load.total_units or 0 }}"
                        data-load-cost="{{ load.estimated_cost or 0 }}"
                        data-load-util="{{ util_value }}"
                        role="button"
                        tabindex="0"
                        aria-label="Select {{ display_label }}"
                        aria-selected="{% if panel_open %}true{% else %}false{% endif %}"
                      >
                        <div class="load-summary-grid">
                          <div class="load-summary-id summary-cell">
                            <div class="load-id">
                              <div class="load-title-row">
                                <span class="load-title-label">{{ display_label }}</span>
                                {% if status == 'APPROVED' %}
                                  <span class="badge badge-success load-status-badge">Approved</span>
                                {% elif status == 'DRAFT' %}
                                  <span class="badge badge-warning load-status-badge">Draft</span>
                                {% endif %}
                              </div>
                              <div class="subtext">
                                {{ load.origin_plant }}
                                <span class="route-arrow" aria-hidden="true">&rarr;</span>
                                {{ load.destination_state }}
                                <span class="route-meta" aria-label="Stops and miles">
                                  &middot;
                                  {% if load.stop_count == 1 %}
                                    1 stop
                                  {% else %}
                                    {{ load.stop_count }} stops
                                  {% endif %}
                                  &middot;
                                  {{ miles }} mi
                                </span>
                              </div>
                            </div>
                          </div>

                          <div class="load-summary-details summary-cell">
                            <div class="load-detail-line">
                              <span class="detail-label">Units:</span>
                              <span class="detail-value">{{ load.total_units }}</span>
                            </div>
                            <div class="load-detail-line">
                              <span class="detail-label">Ship On:</span>
                              <span class="detail-date">{{ load.ship_date | short_date }}</span>
                              {% if load.ship_date_status == 'PAST_DUE' %}
                                <span class="badge badge-danger badge-compact">Past Due</span>
                              {% elif load.ship_date_status == 'DUE_SOON' %}
                                <span class="badge badge-warning badge-compact">Due Soon</span>
                              {% endif %}
                            </div>
                          </div>

                          <div class="load-summary-metric util summary-cell" data-load-id="{{ load.id }}">
                            <div class="util-meta">
                              <span class="metric-value util-pct {{ util_class }}" data-util-value>{{ util_value }}%</span>
                              <span class="util-grade {{ util_class }}" data-util-grade>GRADE {{ util_grade }}</span>
                            </div>
                            <div class="util-progress">
                              <span class="util-fill {{ util_class }}" data-util-fill style="width: {{ util_width }}%;"></span>
                            </div>
                          </div>

                          <div class="load-summary-metric cost summary-cell">
                            <div class="fin-line fin-freight">
                              Freight: <span class="fin-freight-value">${{ "{:,.0f}".format((load.estimated_cost or 0) | float) }}</span>
                            </div>
                            <div class="fin-line fin-sales">
                              Sales Value: <span class="fin-sales-value">${{ "{:,.0f}".format((load.total_sales or 0) | float) }}</span>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="load-detail-panel hidden" id="load-detail-{{ load.id }}" data-load-id="{{ load.id }}">
                    {% set reject_target = 'load-' ~ load.id %}
                    {% set order_error_id = '' %}
                    {% if feedback_target.startswith('order-' ~ load.id ~ '-') %}
                      {% set order_error_id = feedback_target | replace('order-' ~ load.id ~ '-', '') %}
                    {% endif %}
                    <div class="load-approval-stash hidden" data-approval-stash>
                      <div class="load-approval-actions-slot" data-approval-actions-slot>
                        <div class="load-approval-actions">
                          {% if status == 'APPROVED' %}
                            <span class="approval-status approved">Approved</span>
                          {% else %}
                            <span class="approval-status">Pending Approval</span>
                          {% endif %}
                          {% if tab != 'final' %}
                            <form method="post" action="{{ url_for('update_load_status', load_id=load.id) }}" data-async-approve>
                              <input type="hidden" name="action" value="approve_lock">
                              <input type="hidden" name="plants" value="{{ plant_filter_param }}">
                              <button class="btn-success approval-btn" type="submit" {% if status == 'APPROVED' %}disabled{% endif %}>Approve</button>
                            </form>
                            <button class="btn-danger approval-btn feedback-toggle" type="button" data-feedback-target="load-reject-{{ load.id }}" {% if status == 'APPROVED' %}disabled{% endif %}>Reject</button>
                          {% endif %}
                        </div>
                      </div>
                      <div class="load-approval-warning-slot" data-approval-warning-slot>
                        <div class="alert-message warning{% if not load.over_capacity %} hidden{% endif %}" id="over-capacity-{{ load.id }}">
                          <strong>Over Capacity:</strong> This is a single-order load that exceeds trailer capacity. Review before dispatch.
                        </div>
                      </div>
                    </div>

                    <div class="inline-feedback-panel load-feedback-panel{% if feedback_target != reject_target %} hidden{% endif %}" id="load-reject-{{ load.id }}">
                      <form class="feedback-form-inline" method="post" action="{{ url_for('reject_load', load_id=load.id) }}">
                        <div class="feedback-fields">
                          <label>
                            Rejection reason (required)
                            <select class="select-field" name="reason_category" required>
                              <option value="">Select reason</option>
                              {% for reason in load_rejection_reasons %}
                                <option value="{{ reason }}">{{ reason }}</option>
                              {% endfor %}
                            </select>
                          </label>
                          <label>
                            Additional details (minimum 10 characters)
                            <textarea name="details" rows="3" minlength="10" required placeholder="Add context for the rejection."></textarea>
                          </label>
                        </div>
                        {% if feedback_target == reject_target and feedback_error %}
                          <div class="form-error">{{ feedback_error }}</div>
                        {% endif %}
                        <div class="feedback-actions">
                          <button class="btn-danger" type="submit">Submit Rejection</button>
                          <button class="btn-ghost feedback-cancel" type="button" data-feedback-cancel>Cancel</button>
                        </div>
                      </form>
                    </div>

                    <div class="inline-feedback-panel order-feedback-panel{% if not order_error_id %} hidden{% endif %}" id="order-remove-{{ load.id }}" data-load-id="{{ load.id }}">
                      <form class="feedback-form-inline" method="post" action="{{ url_for('remove_order_from_load', load_id=load.id) }}">
                        <input type="hidden" name="order_id" value="{{ order_error_id }}">
                        <div class="order-feedback-header">
                          <span class="metric-label">Remove Order</span>
                          <span class="metric-value" data-order-label>
                            {% if order_error_id %}#{{ order_error_id }}{% else %}Select an order in the schematic{% endif %}
                          </span>
                        </div>
                        <div class="feedback-fields">
                          <label>
                            Removal reason (required)
                            <select class="select-field" name="reason_category" required>
                              <option value="">Select reason</option>
                              {% for reason in order_removal_reasons %}
                                <option value="{{ reason }}">{{ reason }}</option>
                              {% endfor %}
                            </select>
                          </label>
                          <label>
                            Additional details (minimum 10 characters)
                            <textarea name="details" rows="3" minlength="10" required placeholder="Add context for removing this order."></textarea>
                          </label>
                        </div>
                        {% if order_error_id and feedback_error %}
                          <div class="form-error">{{ feedback_error }}</div>
                        {% endif %}
                        <div class="feedback-actions">
                          <button class="btn-danger btn-xs" type="submit">Submit Removal</button>
                          <button class="btn-ghost btn-xs feedback-cancel" type="button" data-feedback-cancel>Cancel</button>
                        </div>
                      </form>
                    </div>

                    <div class="load-detail-grid load-approval-grid">
                      {% include 'partials/load_schematic_card.html' %}

                      <div class="manifest-card">
                        <div class="card-header-row">
                          <div class="card-header-left">
                            <h3>Freight Manifest</h3>
                            {% if load.ship_date %}
                              <span class="meta-chip">Ship Date {{ load.ship_date }}</span>
                            {% endif %}
                          </div>
                        </div>
                        <div class="table-container">
                          <table class="manifest-table manifest-grouped">
                            <thead>
                              <tr>
                                <th>Order</th>
                                <th>Customer Info</th>
                              </tr>
                            </thead>
                            <tbody>
                              {% for group in load.manifest_groups %}
                                {% set row_id = 'manifest-' ~ load.id ~ '-' ~ loop.index0 %}
                                <tr class="manifest-order-row" data-target="{{ row_id }}">
                                  <td>
                                    <div class="manifest-order-cell">
                                      <div class="manifest-order-top">
                                        <button class="manifest-toggle" type="button">+</button>
                                        <span class="order-color-dot" style="background: {{ group.color }};"></span>
                                        <span class="manifest-order-id">#{{ group.order_id }}</span>
                                      </div>
                                      <div class="due-cell">
                                        <span class="due-date">{{ group.due_date }}</span>
                                        {% if group.due_status == 'PAST_DUE' %}
                                          <span class="badge badge-danger">Past Due</span>
                                        {% elif group.due_status == 'DUE_SOON' %}
                                          <span class="badge badge-warning">Due Soon</span>
                                        {% endif %}
                                        {% if group.early_days and group.early_days > 0 and group.due_status != 'PAST_DUE' %}
                                          <span class="badge badge-info">Early {{ group.early_days }}d</span>
                                        {% endif %}
                                      </div>
                                    </div>
                                  </td>
                                  <td>
                                    <div class="manifest-customer-cell">
                                      <div class="manifest-customer-name">{{ group.cust_name }}</div>
                                      <div class="manifest-customer-location">{% if group.city %}{{ group.city }}, {% endif %}{{ group.state }}</div>
                                    </div>
                                  </td>
                                </tr>
                                <tr class="manifest-item-row hidden" id="{{ row_id }}">
                                  <td colspan="2">
                                    <table class="manifest-subtable">
                                      <thead>
                                        <tr>
                                          <th>SKU</th>
                                          <th>Description</th>
                                          <th>Qty</th>
                                          <th>Length</th>
                                        </tr>
                                      </thead>
                                      <tbody>
                                        {% for line in group.lines %}
                                          <tr>
                                            <td>{{ line.sku }}</td>
                                            <td>{{ line.item }}</td>
                                            <td>{{ line.qty }}</td>
                                            <td>{{ (line.unit_length_ft or 0) | round(1) }} ft</td>
                                          </tr>
                                        {% endfor %}
                                      </tbody>
                                    </table>
                                  </td>
                                </tr>
                              {% endfor %}
                            </tbody>
                          </table>
                        </div>
                      </div>

                      <div class="map-card">
                        <div class="load-map" id="load-map-{{ load.id }}" data-stops='{{ load.map_stops | tojson }}'></div>
                      </div>
                    </div>
                  </div>
                            {% endfor %}
                          </div>
                        </div>
                      {% endif %}
                    {% endfor %}
                  {% else %}
                    <div class="empty-state">
                      <span class="material-symbols-outlined">local_shipping</span>
                      <p>No loads available yet.</p>
                    </div>
                  {% endif %}
                  <div class="hidden" id="load-detail-stash" data-load-review-stash aria-hidden="true"></div>
                </div>
              </div>
            </div>

            <div class="loads-preview-shell">
              <div class="loads-shell-header loads-shell-header-right">
                <div class="selected-preview-bar">
                  <div class="selected-preview-meta">
                    <span class="material-symbols-outlined selected-load-icon" aria-hidden="true">info</span>
                    <span class="meta-label">Selected Load:</span>
                    <span class="loads-review-label" id="selected-load-label"></span>
                  </div>
                  <div class="selected-load-actions" id="selected-load-actions"></div>
                </div>
                <div class="selected-load-warning" id="selected-load-warning"></div>
              </div>

              <aside class="loads-review" aria-label="Selected load preview">
                <div class="loads-review-pane" id="load-review-pane" data-load-review-pane>
                  <div class="loads-review-empty" id="load-review-empty">Select a load to review.</div>
                </div>
              </aside>
            </div>
          </div>

    </div>
  </section>

  {% if tab != 'final' %}
    <div class="modal-backdrop hidden" id="manual-load-modal" data-manual-load-modal>
      <div class="modal-card">
        <div class="modal-header">
          <div class="modal-title">
            <h3>Build Manual Load</h3>
            <p>Select orders from the current optimized Draft Loads pool.</p>
          </div>
          <button class="btn-icon" type="button" data-manual-load-close aria-label="Close manual load builder">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <form id="manual-load-form" method="post" action="{{ url_for('manual_load_create') }}" onsubmit="return confirm('Create this manual load and re-optimize the remaining orders?');">
          <div class="modal-body">
            <input type="hidden" name="plant" id="manual-load-plant" value="{% if plant_filters|length == 1 %}{{ plant_filters[0] }}{% elif plants|length %}{{ plants[0] }}{% endif %}">
            <input type="hidden" name="trailer_type" value="STEP_DECK">

            <div class="manual-builder-layout">
              <div class="manual-builder-left">
                <div class="manual-base-panel">
                  <div class="manual-column-header">
                    <span class="metric-label">Base Order</span>
                    <span class="subtext">Search and select a base order.</span>
                  </div>
                  <div class="manual-base-search">
                    <span class="material-symbols-outlined">search</span>
                    <input class="select-field" type="text" id="manual-load-search" placeholder="Search orders..." autocomplete="off" aria-label="Search base order">
                  </div>
                  <div class="manual-order-list" id="manual-load-search-results"></div>
                </div>

                <div class="manual-suggest-panel">
                  <div class="manual-column-header">
                    <span class="metric-label">Suggested Orders</span>
                    <span class="subtext" id="manual-load-suggest-meta"></span>
                  </div>
                  <div class="manual-suggest-table" id="manual-load-suggest-list">
                    <div class="subtext">Select a base order to see suggestions.</div>
                  </div>
                </div>
              </div>

              <div class="manual-builder-right">
                <div class="manual-metrics-card">
                  <div class="manual-metrics-header">
                    <span class="metric-label">Proposed Load Metrics</span>
                    <span class="subtext" id="manual-load-util-meta"></span>
                  </div>
                  <div class="manual-util-bar">
                    <span class="manual-util-fill" id="manual-load-util-fill" style="width: 0%;"></span>
                  </div>
                  <div class="manual-metrics-grid">
                    <div class="manual-metric">
                      <span class="metric-label">Total Qty</span>
                      <span class="metric-value" id="manual-load-qty">--</span>
                    </div>
                    <div class="manual-metric">
                      <span class="metric-label">Total Length</span>
                      <span class="metric-value" id="manual-load-length">--</span>
                    </div>
                    <div class="manual-metric">
                      <span class="metric-label">Orders</span>
                      <span class="metric-value" id="manual-load-orders">--</span>
                    </div>
                  </div>
                </div>

                <div class="manual-route-card">
                  <div class="manual-column-header">
                    <span class="metric-label">Draft Route</span>
                    <span class="subtext">Base order + selected stops</span>
                  </div>
                  <ol class="manual-route-list" id="manual-load-route-list">
                    <li class="subtext">Select a base order to draft a route.</li>
                  </ol>
                </div>

                <div id="manual-load-selected-inputs" class="hidden"></div>
              </div>
            </div>
</div>
          <div class="modal-footer">
            <button class="btn-ghost" type="button" data-manual-load-cancel>Cancel</button>
            <button class="btn-primary" type="submit" id="manual-load-submit" disabled>Create Manual Load</button>
          </div>
        </form>
      </div>
    </div>
    <div class="modal-backdrop hidden" id="manual-add-modal" data-manual-add-modal>
      <div class="modal-card">
        <div class="modal-header">
          <div class="modal-title">
            <h3>Manually Add Orders</h3>
            <p>Add nearby draft-scope orders that fit in the remaining trailer space. This converts the load to MANUAL and re-optimizes the remaining orders.</p>
          </div>
          <button class="btn-icon" type="button" data-manual-add-close aria-label="Close manual add orders">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <form id="manual-add-form">
          <div class="modal-body">
            <div class="manual-util-card manual-add-util">
              <div class="manual-util-header">
                <span class="metric-label">Remaining Capacity</span>
                <span class="subtext" id="manual-add-util-meta"></span>
              </div>
              <div class="manual-util-bar">
                <span class="manual-util-fill" id="manual-add-util-fill" style="width: 0%;"></span>
              </div>
            </div>
            <div class="subtext" id="manual-add-meta"></div>
            <div class="manual-order-list" id="manual-add-list">
              <div class="subtext">Select a load’s “Manually Add Orders” button to see suggestions.</div>
            </div>
            <div class="subtext hidden" id="manual-add-error"></div>
          </div>
          <div class="modal-footer">
            <button class="btn-ghost" type="button" data-manual-add-cancel>Cancel</button>
            <button class="btn-primary" type="submit" id="manual-add-submit" disabled>Add Selected Orders</button>
          </div>
        </form>
      </div>
    </div>
  {% endif %}

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const mapInstances = new Map();
    const loadsPage = document.querySelector('.loads-page');
    const loadsTab = loadsPage ? (loadsPage.dataset.loadsTab || '') : '';
    const todayToggle = document.querySelector('[data-today-toggle]');
    const todayPanel = document.querySelector('[data-today-panel]');
    const todayInput = document.getElementById('loads-today-input');
    const todayApply = document.querySelector('[data-today-apply]');
    const todayClear = document.querySelector('[data-today-clear]');
    const sortToggle = document.querySelector('[data-sort-toggle]');
    const sortPanel = document.querySelector('[data-sort-panel]');

    function openTodayPanel() {
      if (!todayPanel || !todayToggle) return;
      todayPanel.classList.remove('hidden');
      todayToggle.setAttribute('aria-expanded', 'true');
      if (todayInput) todayInput.focus();
    }

    function closeTodayPanel() {
      if (!todayPanel || !todayToggle) return;
      todayPanel.classList.add('hidden');
      todayToggle.setAttribute('aria-expanded', 'false');
    }

    function applyTodayOverride(value) {
      const url = new URL(window.location.href);
      const params = url.searchParams;
      if (value) {
        params.set('today', value);
      } else {
        params.set('today', 'clear');
      }
      url.search = params.toString();
      window.location.assign(url.toString());
    }

    if (todayToggle) {
      todayToggle.addEventListener('click', () => {
        if (!todayPanel) return;
        const isOpen = !todayPanel.classList.contains('hidden');
        if (isOpen) {
          closeTodayPanel();
        } else {
          openTodayPanel();
        }
      });
    }

    if (todayPanel && todayPanel.dataset.todayAutoshow === 'true') {
      openTodayPanel();
    }

    if (todayApply) {
      todayApply.addEventListener('click', () => {
        applyTodayOverride(todayInput ? todayInput.value : '');
      });
    }

    if (todayClear) {
      todayClear.addEventListener('click', () => {
        applyTodayOverride('');
      });
    }

    if (todayInput) {
      todayInput.addEventListener('keydown', (event) => {
        if (event.key !== 'Enter') return;
        event.preventDefault();
        applyTodayOverride(todayInput.value);
      });
    }

    function openSortPanel() {
      if (!sortPanel || !sortToggle) return;
      sortPanel.classList.remove('hidden');
      sortToggle.setAttribute('aria-expanded', 'true');
    }

    function closeSortPanel() {
      if (!sortPanel || !sortToggle) return;
      sortPanel.classList.add('hidden');
      sortToggle.setAttribute('aria-expanded', 'false');
    }

    if (sortToggle) {
      sortToggle.addEventListener('click', () => {
        if (!sortPanel) return;
        const isOpen = !sortPanel.classList.contains('hidden');
        if (isOpen) {
          closeSortPanel();
        } else {
          openSortPanel();
        }
      });
    }

    function toRad(value) {
      return (value * Math.PI) / 180;
    }

    function toDeg(value) {
      return (value * 180) / Math.PI;
    }

    function bearing(start, end) {
      const lat1 = toRad(start[0]);
      const lat2 = toRad(end[0]);
      const deltaLon = toRad(end[1] - start[1]);
      const y = Math.sin(deltaLon) * Math.cos(lat2);
      const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(deltaLon);
      return (toDeg(Math.atan2(y, x)) + 360) % 360;
    }

    function createStopIcon(stop) {
      const type = stop.type || 'stop';
      const sequence = stop.sequence || '';
      let html = '';
      if (type === 'origin') {
        html = '<div class="stop-marker origin"><span class="material-symbols-outlined">home</span></div>';
      } else if (type === 'final') {
        html = `<div class="stop-marker final"><span class="material-symbols-outlined">flag</span><span class="stop-num">${sequence}</span></div>`;
      } else {
        html = `<div class="stop-marker"><span class="stop-num">${sequence}</span></div>`;
      }
      return L.divIcon({
        className: 'stop-marker-wrapper',
        html,
        iconSize: [28, 28],
        iconAnchor: [14, 14],
      });
    }

    function addRouteArrows(map, coords) {
      coords.forEach((point, idx) => {
        if (idx >= coords.length - 1) return;
        const next = coords[idx + 1];
        const mid = [(point[0] + next[0]) / 2, (point[1] + next[1]) / 2];
        const angle = bearing(point, next);
        const icon = L.divIcon({
          className: 'route-arrow',
          html: `<div style="transform: rotate(${angle}deg)">></div>`,
          iconSize: [20, 20],
          iconAnchor: [10, 10],
        });
        L.marker(mid, { icon, interactive: false }).addTo(map);
      });
    }

    function initLoadMap(container) {
      if (!container || mapInstances.has(container.id)) {
        return;
      }
      const stops = JSON.parse(container.dataset.stops || '[]');
      const validStops = stops.filter((stop) => stop.lat !== null && stop.lng !== null);
      if (!validStops.length) {
        container.innerHTML = '<div class="empty">No map coordinates available for stops.</div>';
        return;
      }

      const map = L.map(container, {
        zoomControl: true,
        scrollWheelZoom: false,
      });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 18,
      }).addTo(map);

      const bounds = [];
      const lineCoords = validStops.map((stop) => {
        const coords = [stop.lat, stop.lng];
        bounds.push(coords);
        return coords;
      });

      if (lineCoords.length > 1) {
        L.polyline(lineCoords, {
          color: '#38bdf8',
          weight: 3,
          opacity: 0.85,
        }).addTo(map);
        addRouteArrows(map, lineCoords);
      }

      validStops.forEach((stop) => {
        const coords = [stop.lat, stop.lng];
        const icon = createStopIcon(stop);
        const marker = L.marker(coords, { icon }).addTo(map);
        const label = stop.label || 'Stop';
        marker.bindPopup(label);
      });

      if (bounds.length === 1) {
        map.setView(bounds[0], 9);
      } else {
        map.fitBounds(bounds, { padding: [20, 20] });
      }
      mapInstances.set(container.id, map);
    }

    function closeOrderFeedbackPanels() {
      document.querySelectorAll('.order-feedback-panel').forEach((panel) => {
        panel.classList.add('hidden');
      });
    }

    function closeLoadFeedbackPanels() {
      document.querySelectorAll('.load-feedback-panel').forEach((panel) => {
        panel.classList.add('hidden');
      });
    }

    document.querySelectorAll('.feedback-toggle').forEach((btn) => {
      btn.addEventListener('click', () => {
        const targetId = btn.dataset.feedbackTarget;
        const panel = document.getElementById(targetId);
        if (!panel) return;
        const isHidden = panel.classList.contains('hidden');
        closeOrderFeedbackPanels();
        closeLoadFeedbackPanels();
        if (isHidden) {
          panel.classList.remove('hidden');
        }
      });
    });

    function openOrderFeedbackPanel(loadId, orderId) {
      const panel = document.getElementById(`order-remove-${loadId}`);
      if (!panel) return;
      const input = panel.querySelector('input[name="order_id"]');
      if (input) input.value = orderId || '';
      const label = panel.querySelector('[data-order-label]');
      if (label) {
        label.textContent = orderId ? `#${orderId}` : 'Select an order in the schematic';
      }
      panel.classList.remove('hidden');
    }

    function highlightSchematicOrder(loadId, orderId, active) {
      const card = document.getElementById(`schematic-card-${loadId}`);
      if (!card) return;
      const blocks = card.querySelectorAll('.unit-block[data-order-id]');
      blocks.forEach((block) => {
        const match = (block.dataset.orderId || '') === (orderId || '');
        block.classList.toggle('highlighted', Boolean(active && match));
        block.classList.toggle('dimmed', Boolean(active && !match));
      });
    }

    function bindSchematicRemove(root = document) {
      root.querySelectorAll('.js-schematic-remove').forEach((btn) => {
        if (btn.dataset.bound === 'true') return;
        btn.dataset.bound = 'true';
        btn.addEventListener('mouseenter', () => {
          highlightSchematicOrder(btn.dataset.loadId, btn.dataset.orderId, true);
        });
        btn.addEventListener('mouseleave', () => {
          highlightSchematicOrder(btn.dataset.loadId, btn.dataset.orderId, false);
        });
        btn.addEventListener('click', (event) => {
          event.preventDefault();
          event.stopPropagation();
          const loadId = btn.dataset.loadId;
          const orderId = btn.dataset.orderId;
          if (!loadId || !orderId) return;
          closeLoadFeedbackPanels();
          closeOrderFeedbackPanels();
          openOrderFeedbackPanel(loadId, orderId);
        });
      });
    }

    function updateUtilSummary(loadId, payload) {
      const container = document.querySelector(`.load-summary-metric.util[data-load-id="${loadId}"]`);
      if (!container) return;
      const pct = Math.round(payload.utilization_pct || 0);
      const grade = payload.utilization_grade || 'F';
      const utilValue = container.querySelector('[data-util-value]');
      const utilGrade = container.querySelector('[data-util-grade]');
      const utilFill = container.querySelector('[data-util-fill]');
      if (utilValue) utilValue.textContent = `${pct}%`;
      if (utilGrade) utilGrade.textContent = `Grade ${grade}`;
      if (utilFill) {
        utilFill.style.width = `${Math.min(100, pct)}%`;
        utilFill.classList.remove('success', 'warning', 'danger');
        if (pct >= 80) {
          utilFill.classList.add('success');
        } else if (pct >= 70) {
          utilFill.classList.add('warning');
        } else {
          utilFill.classList.add('danger');
        }
      }
    }

    function bindTrailerSelect(root = document) {
      root.querySelectorAll('.load-trailer-select').forEach((select) => {
        if (select.dataset.bound === 'true') return;
        select.dataset.bound = 'true';
        select.addEventListener('change', () => {
          const loadId = select.dataset.loadId;
          if (!loadId) return;
          select.disabled = true;
          const formData = new FormData();
          formData.append('trailer_type', select.value);
          fetch(`/loads/${loadId}/trailer`, {
            method: 'POST',
            body: formData,
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error('Trailer update failed');
              }
              const tabParam = loadsTab ? `?tab=${encodeURIComponent(loadsTab)}` : '';
              return fetch(`/loads/${loadId}/schematic${tabParam}`);
            })
            .then((response) => response.json())
            .then((payload) => {
              if (payload && payload.schematic_html) {
                const existing = document.getElementById(`schematic-card-${loadId}`);
                  if (existing) {
                    existing.outerHTML = payload.schematic_html;
                    const replacement = document.getElementById(`schematic-card-${loadId}`);
                    bindSchematicRemove(replacement || document);
                    bindTrailerSelect(replacement || document);
                    bindManualAddButtons(replacement || document);
                  }
                }
              updateUtilSummary(loadId, payload || {});
              const alert = document.getElementById(`over-capacity-${loadId}`);
              if (alert) {
                alert.classList.toggle('hidden', !(payload && payload.over_capacity));
              }
            })
            .catch(() => {
              window.alert('Unable to update trailer type. Please try again.');
            })
            .finally(() => {
              select.disabled = false;
            });
        });
      });
    }

    function updateSectionVisibility() {
      document.querySelectorAll('.load-section').forEach((section) => {
        const visibleRows = section.querySelectorAll('.load-row:not(.hidden)');
        section.classList.toggle('hidden', visibleRows.length === 0);
      });
    }

    function recalcOptimizationSummary() {
      const rows = Array.from(document.querySelectorAll('.load-row'));
      let loadCount = 0;
      const gradeCounts = { A: 0, B: 0, C: 0, D: 0, F: 0 };

      rows.forEach((row) => {
        if (row.dataset.removed === 'true') return;
        const grade = (row.dataset.loadGrade || 'F').toUpperCase();
        loadCount += 1;
        gradeCounts[grade] = (gradeCounts[grade] || 0) + 1;
      });

      const loadChip = document.querySelector('[data-opt-total-loads]');

      if (loadChip) loadChip.textContent = String(loadCount);
      const activeDraftTabCount = document.querySelector('.load-tab.active [data-tab-count="draft"]');
      if (activeDraftTabCount) activeDraftTabCount.textContent = String(loadCount);

      Object.entries(gradeCounts).forEach(([grade, count]) => {
        const el = document.querySelector(`[data-grade-count="${grade}"]`);
        if (el) el.textContent = count;
      });
    }

    function updateTabCounts(tabCounts) {
      if (!tabCounts) return;
      const draftEl = document.querySelector('[data-tab-count="draft"]');
      const finalEl = document.querySelector('[data-tab-count="final"]');
      if (draftEl && Number.isFinite(Number(tabCounts.draft))) draftEl.textContent = String(tabCounts.draft);
      if (finalEl && Number.isFinite(Number(tabCounts.final))) {
        const finalCount = Number(tabCounts.final);
        finalEl.textContent = String(finalCount);
        const finalTab = finalEl.closest('.load-tab');
        if (finalTab) {
          if (finalCount > 0) {
            finalTab.classList.remove('disabled');
            finalTab.removeAttribute('aria-disabled');
            finalTab.removeAttribute('tabindex');
          } else {
            finalTab.classList.add('disabled');
            finalTab.setAttribute('aria-disabled', 'true');
            finalTab.setAttribute('tabindex', '-1');
          }
        }
      }
    }

    function updateApprovalTracker(progress) {
      if (!progress) return;
      const tracker = document.querySelector('[data-approval-tracker]');
      if (!tracker) return;

      const approvedOrders = Number(progress.approved_orders || 0);
      const totalOrders = Number(progress.total_orders || 0);
      const pctRaw = Number(progress.progress_pct || 0);
      const pctDisplay = Math.round(pctRaw);
      const pctWidth = Math.max(0, Math.min(100, pctDisplay));

      const pctEl = tracker.querySelector('[data-approval-pct]');
      if (pctEl) pctEl.textContent = `${pctDisplay}%`;

      const fill = tracker.querySelector('[data-approval-fill]');
      if (fill) fill.style.width = `${pctWidth}%`;

      const bar = tracker.querySelector('[data-approval-bar]');
      if (bar) bar.setAttribute('aria-valuenow', String(pctWidth));

      const countEl = tracker.querySelector('[data-approval-count]');
      if (countEl) countEl.textContent = `${approvedOrders} / ${totalOrders} Orders`;
    }

    let selectedLoadId = null;

    function syncReviewLayoutHeight() {
      const layout = document.querySelector('[data-load-review-layout]');
      if (!layout) return;
      const top = layout.getBoundingClientRect().top;
      const available = window.innerHeight - top - 16;
      const clamped = Math.max(520, Math.floor(available));
      layout.style.setProperty('--loads-review-height', `${clamped}px`);
    }

    function showReviewEmpty(message) {
      if (selectedLoadId) {
        restoreSelectedHeaderElements(selectedLoadId);
      }
      const pane = document.getElementById('load-review-pane');
      const stash = document.getElementById('load-detail-stash');
      if (pane && stash) {
        pane.querySelectorAll('.load-detail-panel').forEach((panel) => {
          panel.classList.add('hidden');
          panel.classList.remove('single-screen');
          stash.appendChild(panel);
        });
      }
      clearSelectedPreviewHeader();
      const empty = document.getElementById('load-review-empty');
      if (empty) {
        empty.textContent = message || 'Select a load to review.';
        empty.classList.remove('hidden');
      }
      const label = document.getElementById('selected-load-label');
      if (label) label.textContent = '';
      document.querySelectorAll('.load-row.selected').forEach((row) => {
        row.classList.remove('selected');
        row.setAttribute('aria-selected', 'false');
      });
      document.querySelectorAll('.load-row-toggle[aria-pressed="true"]').forEach((btn) => btn.setAttribute('aria-pressed', 'false'));
      selectedLoadId = null;
    }

    function clearSelectedPreviewHeader() {
      const actionsHost = document.getElementById('selected-load-actions');
      const warningHost = document.getElementById('selected-load-warning');
      if (actionsHost) actionsHost.innerHTML = '';
      if (warningHost) warningHost.innerHTML = '';
    }

    function restoreSelectedHeaderElements(loadId) {
      const actionsHost = document.getElementById('selected-load-actions');
      const warningHost = document.getElementById('selected-load-warning');
      const panel = document.getElementById(`load-detail-${loadId}`);
      if (!panel) return;

      const actionsSlot = panel.querySelector('[data-approval-actions-slot]');
      const warningSlot = panel.querySelector('[data-approval-warning-slot]');

      const actions = actionsHost?.querySelector('.load-approval-actions');
      if (actions && actionsSlot) actionsSlot.appendChild(actions);

      const warning = warningHost?.querySelector(`#over-capacity-${loadId}`);
      if (warning && warningSlot) warningSlot.appendChild(warning);

      if (actionsHost && !actionsHost.hasChildNodes()) actionsHost.innerHTML = '';
      if (warningHost && !warningHost.hasChildNodes()) warningHost.innerHTML = '';
    }

    function moveSelectedHeaderElements(loadId) {
      const actionsHost = document.getElementById('selected-load-actions');
      const warningHost = document.getElementById('selected-load-warning');
      const panel = document.getElementById(`load-detail-${loadId}`);
      if (!panel) return;
      if (actionsHost) {
        const actions = panel.querySelector('.load-approval-actions');
        if (actions) actionsHost.appendChild(actions);
      }
      if (warningHost) {
        const warning = panel.querySelector(`#over-capacity-${loadId}`);
        if (warning) warningHost.appendChild(warning);
      }
    }

    function stashAllDetailPanels() {
      const stash = document.getElementById('load-detail-stash');
      if (!stash) return;
      if (selectedLoadId) {
        restoreSelectedHeaderElements(selectedLoadId);
        clearSelectedPreviewHeader();
      }
      document.querySelectorAll('.load-detail-panel').forEach((panel) => {
        panel.classList.add('hidden');
        panel.classList.remove('single-screen');
        stash.appendChild(panel);
      });
    }

    function selectLoad(loadId, { scrollIntoView = true } = {}) {
      const pane = document.getElementById('load-review-pane');
      const stash = document.getElementById('load-detail-stash');
      const empty = document.getElementById('load-review-empty');
      if (!pane || !stash) return;
      if (!loadId) return;

      const row = document.querySelector(`.load-row[data-load-id="${loadId}"]`);
      const panel = document.getElementById(`load-detail-${loadId}`);
      if (!row || !panel) {
        showReviewEmpty('Select a load to review.');
        return;
      }

      if (selectedLoadId && selectedLoadId === String(loadId)) {
        if (scrollIntoView) {
          row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        return;
      }

      if (selectedLoadId && selectedLoadId !== String(loadId)) {
        restoreSelectedHeaderElements(selectedLoadId);
        const prevRow = document.querySelector(`.load-row[data-load-id="${selectedLoadId}"]`);
        if (prevRow) {
          prevRow.classList.remove('selected');
          prevRow.setAttribute('aria-selected', 'false');
        }
        const prevPanel = document.getElementById(`load-detail-${selectedLoadId}`);
        if (prevPanel) {
          prevPanel.classList.add('hidden');
          prevPanel.classList.remove('single-screen');
          stash.appendChild(prevPanel);
        }
      }

      selectedLoadId = String(loadId);
      row.classList.add('selected');
      row.setAttribute('aria-selected', 'true');
      const label = document.getElementById('selected-load-label');
      if (label) label.textContent = row.dataset.loadLabel || '';
      if (empty) empty.classList.add('hidden');

      panel.classList.remove('hidden');
      panel.classList.add('single-screen');
      pane.appendChild(panel);
      clearSelectedPreviewHeader();
      moveSelectedHeaderElements(loadId);

      const mapContainer = panel.querySelector('.load-map');
      initLoadMap(mapContainer);
      const mapInstance = mapInstances.get(mapContainer?.id);
      if (mapInstance) {
        setTimeout(() => mapInstance.invalidateSize(), 50);
      }

      if (scrollIntoView) {
        row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }

    function removeLoadFromView(loadId) {
      const row = document.querySelector(`.load-row[data-load-id="${loadId}"]`);
      const panel = document.getElementById(`load-detail-${loadId}`);
      let nextSelectionId = null;
      if (row && selectedLoadId === String(loadId)) {
        restoreSelectedHeaderElements(loadId);
        clearSelectedPreviewHeader();
        const rows = Array.from(document.querySelectorAll('.load-row:not(.hidden)')).filter((r) => r.dataset.removed !== 'true');
        const idx = rows.indexOf(row);
        const nextRow = (idx >= 0 && rows[idx + 1]) ? rows[idx + 1] : (idx > 0 ? rows[idx - 1] : null);
        nextSelectionId = nextRow?.dataset.loadId || null;
      }
      if (panel) {
        const mapContainer = panel.querySelector('.load-map');
        const mapInstance = mapInstances.get(mapContainer?.id);
        if (mapInstance) {
          mapInstance.remove();
          mapInstances.delete(mapContainer.id);
        }
        panel.remove();
      }
      if (row) {
        row.dataset.removed = 'true';
        row.remove();
      }
      updateSectionVisibility();
      recalcOptimizationSummary();
      if (selectedLoadId === String(loadId)) {
        if (nextSelectionId) {
          selectLoad(nextSelectionId, { scrollIntoView: false });
        } else {
          showReviewEmpty('No loads available.');
        }
      }
    }

    function bindAsyncApprove() {
      document.querySelectorAll('form[data-async-approve]').forEach((form) => {
        if (form.dataset.bound === 'true') return;
        form.dataset.bound = 'true';
        form.addEventListener('submit', (event) => {
          event.preventDefault();
          const formData = new FormData(form);
          // `form.action` can be shadowed by an `<input name="action">` inside the form.
          // Always read from the attribute to avoid posting to `/[object HTMLInputElement]`.
          const postUrl = form.getAttribute('action') || '';
          if (!postUrl) {
            window.alert('Unable to approve load: missing form action URL.');
            return;
          }
          form.querySelector('button')?.setAttribute('disabled', 'true');
          fetch(postUrl, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'Accept': 'application/json',
            },
          })
            .then(async (response) => {
              let payload = null;
              const contentType = response.headers.get('Content-Type') || '';
              if (contentType.includes('application/json')) {
                payload = await response.json();
              } else {
                const text = await response.text();
                const titleMatch = text.match(/<title>([^<]+)<\/title>/i);
                const summary = (titleMatch && titleMatch[1] ? titleMatch[1] : '').trim();
                payload = {
                  error: summary || `Request failed (${response.status})`,
                  _raw: text,
                };
              }
              if (!response.ok || !payload || payload.error) {
                const finalUrl = response.url || postUrl;
                const message = `${payload?.error || `Approval failed (${response.status})`}${finalUrl ? `\n\nURL: ${finalUrl}` : ''}`;
                throw new Error(message);
              }
              return payload;
            })
            .then((payload) => {
              removeLoadFromView(payload.load_id);
              updateApprovalTracker(payload.progress);
              updateTabCounts(payload.tab_counts);
            })
            .catch((error) => {
              form.querySelector('button')?.removeAttribute('disabled');
              console.error('Async approve failed', error);
              window.alert(error?.message || 'Unable to approve load. Please try again.');
            });
        });
      });
    }

    document.querySelectorAll('[data-feedback-cancel]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const row = btn.closest('.manifest-feedback-row');
        if (row) {
          row.classList.add('hidden');
          return;
        }
        const panel = btn.closest('.inline-feedback-panel');
        if (panel) {
          panel.classList.add('hidden');
        }
      });
    });

    document.querySelectorAll('.load-row').forEach((row) => {
      row.addEventListener('click', (event) => {
        if (event.target.closest('button')) return;
        if (event.target.closest('a')) return;
        if (event.target.closest('select')) return;
        if (event.target.closest('.inline-feedback-panel')) return;
        selectLoad(row.dataset.loadId, { scrollIntoView: true });
      });

      row.addEventListener('keydown', (event) => {
        if (event.key !== 'Enter' && event.key !== ' ') return;
        event.preventDefault();
        selectLoad(row.dataset.loadId, { scrollIntoView: true });
      });
    });

    const loadSearchInput = document.querySelector('[data-load-search-input]');
    if (loadSearchInput) {
      const applySearch = debounce(() => {
        const query = (loadSearchInput.value || '').trim().toLowerCase();
        document.querySelectorAll('.load-row').forEach((row) => {
          if (row.dataset.removed === 'true') return;
          const haystack = `${row.dataset.loadLabel || ''} ${row.textContent || ''}`.toLowerCase();
          const match = !query || haystack.includes(query);
          row.classList.toggle('hidden', !match);
        });
        updateSectionVisibility();

        const selectedRow = selectedLoadId
          ? document.querySelector(`.load-row[data-load-id="${selectedLoadId}"]`)
          : null;
        const firstVisible = document.querySelector('.load-row:not(.hidden)');

        if (!firstVisible) {
          showReviewEmpty(query ? 'No loads match your search.' : 'No loads available.');
          return;
        }

        if (!selectedRow || selectedRow.classList.contains('hidden')) {
          selectLoad(firstVisible.dataset.loadId, { scrollIntoView: false });
        }
      }, 120);

      loadSearchInput.addEventListener('input', applySearch);
    }

    bindSchematicRemove();
    bindTrailerSelect();
    bindAsyncApprove();
    stashAllDetailPanels();

    const initialRow = document.querySelector('.load-row[data-initial-selected="true"]:not(.hidden)') || document.querySelector('.load-row:not(.hidden)');
    if (initialRow?.dataset?.loadId) {
      selectLoad(initialRow.dataset.loadId, { scrollIntoView: false });
    } else {
      showReviewEmpty('No loads available.');
    }

    syncReviewLayoutHeight();
    window.addEventListener('resize', debounce(syncReviewLayoutHeight, 100));

    document.querySelectorAll('.manifest-order-row').forEach((row) => {
      row.addEventListener('click', (event) => {
        if (event.target.closest('.manifest-toggle')) {
          event.preventDefault();
        } else if (event.target.closest('button') || event.target.closest('form') || event.target.closest('a')) {
          return;
        }
        const targetId = row.dataset.target;
        if (!targetId) return;
        const detailRow = document.getElementById(targetId);
        if (!detailRow) return;
        const toggle = row.querySelector('.manifest-toggle');
        const isHidden = detailRow.classList.contains('hidden');
        detailRow.classList.toggle('hidden');
        row.classList.toggle('open', isHidden);
        if (toggle) toggle.textContent = isHidden ? '-' : '+';
      });
    });

    function debounce(fn, delayMs) {
      let handle;
      return (...args) => {
        clearTimeout(handle);
        handle = setTimeout(() => fn(...args), delayMs);
      };
    }

    function initManualLoadModal() {
      const modal = document.getElementById('manual-load-modal');
      if (!modal) return;

      const openButtons = document.querySelectorAll('[data-manual-load-open]');
      const closeButton = modal.querySelector('[data-manual-load-close]');
      const cancelButton = modal.querySelector('[data-manual-load-cancel]');

      const plantSelect = document.getElementById('manual-load-plant');
      const searchInput = document.getElementById('manual-load-search');
      const resultsContainer = document.getElementById('manual-load-search-results');
      const suggestMeta = document.getElementById('manual-load-suggest-meta');
      const suggestList = document.getElementById('manual-load-suggest-list');
      const submitBtn = document.getElementById('manual-load-submit');
      const selectedInputs = document.getElementById('manual-load-selected-inputs');
      const utilMeta = document.getElementById('manual-load-util-meta');
      const utilFill = document.getElementById('manual-load-util-fill');
      const qtyValue = document.getElementById('manual-load-qty');
      const lengthValue = document.getElementById('manual-load-length');
      const ordersValue = document.getElementById('manual-load-orders');
      const routeList = document.getElementById('manual-load-route-list');
      const trailerSelect = document.getElementById('manual-load-trailer');

      let seedOrder = null;
      let seedOrderData = null;
      let selectedOrders = new Map();
      let cachedSuggestions = [];
      let cachedParams = {};
      let activeSearchController = null;
      let activeSuggestController = null;

      const closeModal = () => {
        modal.classList.add('hidden');
      };

      const resetState = () => {
        seedOrder = null;
        seedOrderData = null;
        selectedOrders = new Map();
        cachedSuggestions = [];
        cachedParams = {};
        if (searchInput) searchInput.value = '';
        if (resultsContainer) resultsContainer.innerHTML = '';
        if (suggestMeta) suggestMeta.textContent = '';
        if (suggestList) {
          suggestList.innerHTML = '<div class="subtext">Select a seed order to see suggestions.</div>';
        }
        updateSelectedState();
        if (submitBtn) submitBtn.disabled = true;
      };

      const openModal = () => {
        resetState();
        modal.classList.remove('hidden');
        if (searchInput) searchInput.focus();
      };

      openButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          openModal();
        });
      });

      if (closeButton) closeButton.addEventListener('click', closeModal);
      if (cancelButton) cancelButton.addEventListener('click', closeModal);

      modal.addEventListener('click', (event) => {
        if (event.target === modal) {
          closeModal();
        }
      });

      document.addEventListener('keydown', (event) => {
        if (event.key !== 'Escape') return;
        if (modal.classList.contains('hidden')) return;
        closeModal();
      });

      if (plantSelect) {
        plantSelect.addEventListener('change', () => {
          resetState();
          if (searchInput) searchInput.value = '';
        });
      }

      if (trailerSelect) {
        trailerSelect.addEventListener('change', () => {
          updateUtilizationUI();
          renderSuggestionList();
        });
      }

      const trailerCapacities = {
        STEP_DECK: 53,
        FLATBED: 53,
        WEDGE: 51,
      };

      const getCapacity = () => {
        const value = (trailerSelect && trailerSelect.value ? trailerSelect.value : 'STEP_DECK')
          .toString()
          .trim()
          .toUpperCase();
        return trailerCapacities[value] || 53;
      };

      const normalizeOrder = (order) => ({
        so_num: (order.so_num || '').toString().trim(),
        cust_name: (order.cust_name || '').toString().trim(),
        due_date: (order.due_date || '').toString().trim(),
        city: (order.city || '').toString().trim(),
        state: (order.state || '').toString().trim(),
        total_length_ft: Number(order.total_length_ft || 0),
        total_qty: Number(order.total_qty || 0),
        utilization_pct: Number(order.utilization_pct || 0),
        distance_miles: order.distance_miles,
      });

      const getSelectedTotalFt = () => {
        let total = 0;
        selectedOrders.forEach((order) => {
          total += Number(order.total_length_ft || 0);
        });
        return total;
      };

      const updateSubmitState = () => {
        if (!submitBtn) return;
        submitBtn.disabled = !seedOrderData;
      };

      const updateUtilizationUI = () => {
        if (!utilMeta || !utilFill) return;
        if (!seedOrderData) {
          utilMeta.textContent = 'Select a base order to see utilization.';
          utilFill.style.width = '0%';
          return;
        }
        const capacity = getCapacity();
        const used = getSelectedTotalFt();
        const remaining = Math.max(capacity - used, 0);
        const pct = capacity ? Math.min(100, Math.round((used / capacity) * 100)) : 0;
        utilMeta.textContent = `Utilization ${pct}% | ${used.toFixed(1)} / ${capacity} ft | ${remaining.toFixed(1)} ft remaining`;
        utilFill.style.width = `${pct}%`;
        utilFill.classList.remove('success', 'warning', 'danger');
        if (pct >= 85) {
          utilFill.classList.add('success');
        } else if (pct >= 70) {
          utilFill.classList.add('warning');
        } else {
          utilFill.classList.add('danger');
        }
      };

      const getSelectedTotalQty = () => {
        let total = 0;
        selectedOrders.forEach((order) => {
          total += Number(order.total_qty || 0);
        });
        return total;
      };

      const updateMetrics = () => {
        if (!qtyValue || !lengthValue || !ordersValue) return;
        if (!seedOrderData) {
          qtyValue.textContent = '--';
          lengthValue.textContent = '--';
          ordersValue.textContent = '--';
          return;
        }
        qtyValue.textContent = getSelectedTotalQty().toLocaleString();
        lengthValue.textContent = `${getSelectedTotalFt().toFixed(1)} ft`;
        ordersValue.textContent = String(selectedOrders.size);
      };

      const updateRoute = () => {
        if (!routeList) return;
        routeList.innerHTML = '';
        if (!seedOrderData) {
          routeList.innerHTML = '<li class="subtext">Select a base order to draft a route.</li>';
          return;
        }

        let index = 0;
        selectedOrders.forEach((order) => {
          const city = order.city || '';
          const state = order.state || '';
          let label = `${city}${city && state ? ', ' : ''}${state}`.trim();
          if (!label) {
            label = `Order #${order.so_num}`;
          }
          const item = document.createElement('li');
          item.className = 'manual-route-stop';
          item.innerHTML = `<span class="manual-route-dot">${index + 1}</span><span class="manual-route-text">${label}</span>`;
          if (order.so_num === seedOrder) {
            item.classList.add('base');
            item.querySelector('.manual-route-text').textContent = `Base - ${label}`;
          }
          routeList.appendChild(item);
          index += 1;
        });
      };

      const updateSelectedState = () => {
        if (selectedInputs) {
          selectedInputs.innerHTML = '';
          selectedOrders.forEach((order) => {
            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'so_nums';
            hidden.value = order.so_num;
            selectedInputs.appendChild(hidden);
          });
        }
        updateUtilizationUI();
        updateMetrics();
        updateRoute();
        updateSubmitState();
      };

      function renderEmpty(container, message) {
        if (!container) return;
        const div = document.createElement('div');
        div.className = 'subtext';
        div.textContent = message;
        container.innerHTML = '';
        container.appendChild(div);
      }

      function renderSearchResults(orders) {
        if (!resultsContainer) return;
        resultsContainer.innerHTML = '';
        if (!orders || orders.length == 0) {
          renderEmpty(resultsContainer, 'No matching draft-scope orders found.');
          return;
        }

        orders.forEach((order) => {
          const soNum = (order.so_num || '').toString().trim();
          if (!soNum) return;

          const button = document.createElement('button');
          button.type = 'button';
          button.className = 'manual-order-item';
          button.dataset.soNum = soNum;

          const title = document.createElement('div');
          title.className = 'manual-order-title';
          title.textContent = `#${soNum}`;

          const meta = document.createElement('div');
          meta.className = 'manual-order-meta';
          const cust = (order.cust_name || '').toString().trim();
          const due = (order.due_date || '').toString().trim();
          const city = (order.city || '').toString().trim();
          const state = (order.state || '').toString().trim();
          const length = order.total_length_ft != null ? `${Number(order.total_length_ft || 0).toFixed(1)} ft` : '';
          const qty = order.total_qty != null ? `${Number(order.total_qty || 0)} units` : '';
          const util = order.utilization_pct != null ? `${Math.round(order.utilization_pct || 0)}% util` : '';
          const bits = [
            cust || 'Customer',
            due ? `Due ${due}` : 'Due --',
            `${city || ''}${city && state ? ', ' : ''}${state || ''}`.trim(),
            length,
            qty,
            util,
          ].filter(Boolean);
          meta.textContent = bits.join(' | ');

          button.appendChild(title);
          button.appendChild(meta);

          if (seedOrder && seedOrder === soNum) {
            button.classList.add('active');
          }

          button.addEventListener('click', () => {
            const normalized = normalizeOrder(order);
            seedOrder = normalized.so_num;
            seedOrderData = normalized;
            selectedOrders = new Map();
            selectedOrders.set(seedOrder, normalized);
            document.querySelectorAll('.manual-order-item.active').forEach((node) => node.classList.remove('active'));
            button.classList.add('active');
              updateSelectedState();
            loadSuggestions();
          });

          resultsContainer.appendChild(button);
        });
      }

      function renderSuggestionList() {
        if (!suggestList) return;
        suggestList.innerHTML = '';

        if (!seedOrderData) {
          renderEmpty(suggestList, 'Select a base order to see suggestions.');
          if (suggestMeta) suggestMeta.textContent = '';
          updateSubmitState();
          updateUtilizationUI();
          updateMetrics();
          return;
        }

        const capacity = getCapacity();
        const used = getSelectedTotalFt();
        const remaining = Math.max(capacity - used, 0);

        const metaBits = [`Remaining ${remaining.toFixed(1)} ft`];
        if (cachedParams.geo_radius) metaBits.push(`Radius ${Math.round(cachedParams.geo_radius)} mi`);
        if (cachedParams.time_window_days) metaBits.push(`Window +/-${cachedParams.time_window_days}d`);
        if (suggestMeta) {
          suggestMeta.textContent = metaBits.join(' | ');
        }

        const visible = cachedSuggestions.filter((item) => {
          const soNum = (item.so_num || '').toString().trim();
          if (!soNum) return false;
          const length = Number(item.total_length_ft || 0);
          if (selectedOrders.has(soNum)) return true;
          return length <= remaining;
        });

        if (!visible.length) {
          renderEmpty(suggestList, 'No nearby draft-scope orders fit in the remaining trailer space.');
          updateSubmitState();
          updateUtilizationUI();
          updateMetrics();
          return;
        }

        const header = document.createElement('div');
        header.className = 'manual-suggest-row head';
        ['Order', 'Customer', 'Due', 'Stop', 'Length', 'Action'].forEach((label) => {
          const cell = document.createElement('div');
          cell.textContent = label;
          header.appendChild(cell);
        });
        suggestList.appendChild(header);

        visible.forEach((item) => {
          const soNum = (item.so_num || '').toString().trim();
          if (!soNum) return;

          const row = document.createElement('div');
          row.className = 'manual-suggest-row';

          const orderCell = document.createElement('div');
          orderCell.textContent = `#${soNum}`;

          const custCell = document.createElement('div');
          custCell.textContent = (item.cust_name || '').toString().trim() || 'Customer';

          const dueCell = document.createElement('div');
          const due = (item.due_date || '').toString().trim();
          dueCell.textContent = due || '--';

          const stopCell = document.createElement('div');
          const city = (item.city || '').toString().trim();
          const state = (item.state || '').toString().trim();
          stopCell.textContent = `${city || ''}${city && state ? ', ' : ''}${state || ''}`.trim();

          const lengthCell = document.createElement('div');
          const length = Number(item.total_length_ft || 0);
          lengthCell.textContent = `${length.toFixed(1)} ft`;

          const actionCell = document.createElement('div');
          const button = document.createElement('button');
          if (selectedOrders.has(soNum)) {
            button.type = 'button';
            button.className = 'btn-ghost btn-xs manual-suggest-action';
            button.textContent = 'Remove';
            button.addEventListener('click', () => {
              selectedOrders.delete(soNum);
              updateSelectedState();
              renderSuggestionList();
            });
          } else {
            button.type = 'button';
            button.className = 'btn-secondary btn-xs manual-suggest-action';
            button.textContent = 'Add';
            button.addEventListener('click', () => {
              const normalized = normalizeOrder(item);
              if (Number(normalized.total_length_ft || 0) > Math.max(getCapacity() - getSelectedTotalFt(), 0)) {
                return;
              }
              selectedOrders.set(soNum, normalized);
              updateSelectedState();
              renderSuggestionList();
            });
          }
          actionCell.appendChild(button);

          [orderCell, custCell, dueCell, stopCell, lengthCell, actionCell].forEach((cell) => row.appendChild(cell));
          suggestList.appendChild(row);
        });

        updateSubmitState();
        updateUtilizationUI();
        updateMetrics();
      }

      const loadSearchResults = debounce(() => {
        if (!plantSelect || !searchInput) return;
        const q = (searchInput.value || '').trim();
        if (!q) {
          if (resultsContainer) resultsContainer.innerHTML = '';
          return;
        }

        const plant = (plantSelect.value || '').trim();
        if (!plant) return;

        if (activeSearchController) activeSearchController.abort();
        activeSearchController = new AbortController();
        const url = `/loads/manual/search?plant=${encodeURIComponent(plant)}&q=${encodeURIComponent(q)}`;
        fetch(url, { signal: activeSearchController.signal })
          .then((response) => response.json())
          .then((payload) => renderSearchResults(payload.orders || []))
          .catch((err) => {
            if (err && err.name === 'AbortError') return;
            renderEmpty(resultsContainer, 'Search failed. Try again.');
          });
      }, 250);

      if (searchInput) {
        searchInput.addEventListener('input', loadSearchResults);
      }

      function renderSuggestions(seed, suggestions, params) {
        cachedSuggestions = Array.isArray(suggestions) ? suggestions : [];
        cachedParams = params || {};

        if (seed && seed.so_num) {
          const normalized = normalizeOrder(seed);
          if (seedOrder !== normalized.so_num) {
            seedOrder = normalized.so_num;
            selectedOrders = new Map();
          }
          seedOrderData = normalized;
          selectedOrders.set(seedOrder, normalized);
        }

        updateSelectedState();
        renderSuggestionList();
      }

      function loadSuggestions() {
        if (!plantSelect || !seedOrder) return;
        const plant = (plantSelect.value || '').trim();
        if (!plant) return;

        if (activeSuggestController) activeSuggestController.abort();
        activeSuggestController = new AbortController();
        if (suggestList) suggestList.innerHTML = '<div class="subtext">Loading suggestions...</div>';
        if (submitBtn) submitBtn.disabled = true;

        const url = `/loads/manual/suggest?plant=${encodeURIComponent(plant)}&seed=${encodeURIComponent(seedOrder)}`;
        fetch(url, { signal: activeSuggestController.signal })
          .then((response) => response.json())
          .then((payload) => {
            renderSuggestions(payload.seed || null, payload.suggestions || [], payload.params || {});
          })
          .catch((err) => {
            if (err && err.name === 'AbortError') return;
            renderEmpty(suggestList, 'Suggestion lookup failed. Try again.');
          });
      }
    }

    let manualAddApi = null;

    function bindManualAddButtons(root = document) {
      root.querySelectorAll('.js-manual-add-open').forEach((btn) => {
        if (btn.dataset.bound === 'true') return;
        btn.dataset.bound = 'true';
        btn.addEventListener('click', (event) => {
          event.preventDefault();
          event.stopPropagation();
          const loadId = btn.dataset.loadId;
          if (!loadId) return;
          if (!manualAddApi || typeof manualAddApi.open !== 'function') return;
          manualAddApi.open(loadId);
        });
      });
    }

    function initManualAddModal() {
      const modal = document.getElementById('manual-add-modal');
      if (!modal) return;

      const closeButton = modal.querySelector('[data-manual-add-close]');
      const cancelButton = modal.querySelector('[data-manual-add-cancel]');
      const form = document.getElementById('manual-add-form');
      const meta = document.getElementById('manual-add-meta');
      const list = document.getElementById('manual-add-list');
      const error = document.getElementById('manual-add-error');
      const submitBtn = document.getElementById('manual-add-submit');
      const utilMeta = document.getElementById('manual-add-util-meta');
      const utilFill = document.getElementById('manual-add-util-fill');

      let activeLoadId = null;
      let activeController = null;
      let cachedSuggestions = [];
      let cachedSpace = {};
      let cachedParams = {};
      let selectedOrders = new Map();

      const setError = (message) => {
        if (!error) return;
        if (!message) {
          error.classList.add('hidden');
          error.textContent = '';
          return;
        }
        error.textContent = message;
        error.classList.remove('hidden');
      };

      const closeModal = () => {
        if (activeController) activeController.abort();
        activeController = null;
        activeLoadId = null;
        cachedSuggestions = [];
        cachedSpace = {};
        cachedParams = {};
        selectedOrders = new Map();
        if (utilMeta) utilMeta.textContent = '';
        if (utilFill) utilFill.style.width = '0%';
        modal.classList.add('hidden');
      };

      const updateSubmitState = () => {
        if (!submitBtn) return;
        submitBtn.disabled = selectedOrders.size === 0;
      };

      const renderEmpty = (message) => {
        if (!list) return;
        list.innerHTML = '';
        const div = document.createElement('div');
        div.className = 'subtext';
        div.textContent = message;
        list.appendChild(div);
      };

      const getSelectedTotalFt = () => {
        let total = 0;
        selectedOrders.forEach((order) => {
          total += Number(order.total_length_ft || 0);
        });
        return total;
      };

      const normalizeOrder = (order) => ({
        so_num: (order.so_num || '').toString().trim(),
        cust_name: (order.cust_name || '').toString().trim(),
        due_date: (order.due_date || '').toString().trim(),
        city: (order.city || '').toString().trim(),
        state: (order.state || '').toString().trim(),
        total_length_ft: Number(order.total_length_ft || 0),
        utilization_pct: Number(order.utilization_pct || 0),
        distance_miles: order.distance_miles,
      });

      const updateUtilizationUI = () => {
        if (!utilMeta || !utilFill) return;
        const capacity = Number(cachedSpace.capacity_ft || 0);
        const baseUsed = Number(cachedSpace.used_ft || 0);
        const selected = getSelectedTotalFt();
        const used = baseUsed + selected;
        const remaining = capacity ? Math.max(capacity - used, 0) : 0;
        const pct = capacity ? Math.min(100, Math.round((used / capacity) * 100)) : 0;
        if (!capacity) {
          utilMeta.textContent = 'No capacity data available.';
          utilFill.style.width = '0%';
          return;
        }
        utilMeta.textContent = `${used.toFixed(1)} ft used / ${capacity} ft capacity | ${remaining.toFixed(1)} ft remaining`;
        utilFill.style.width = `${pct}%`;
        utilFill.classList.remove('success', 'warning', 'danger');
        if (pct >= 85) {
          utilFill.classList.add('success');
        } else if (pct >= 70) {
          utilFill.classList.add('warning');
        } else {
          utilFill.classList.add('danger');
        }
      };

      const renderSuggestionList = () => {
        if (!list) return;
        list.innerHTML = '';

        const capacity = Number(cachedSpace.capacity_ft || 0);
        const baseUsed = Number(cachedSpace.used_ft || 0);
        const selected = getSelectedTotalFt();
        const remaining = capacity ? Math.max(capacity - (baseUsed + selected), 0) : 0;

        const metaBits = [];
        if (capacity) metaBits.push(`Remaining ${remaining.toFixed(1)} ft`);
        if (cachedParams.geo_radius) metaBits.push(`Radius ${Math.round(cachedParams.geo_radius)} mi`);
        if (cachedParams.time_window_days) metaBits.push(`Window +/-${cachedParams.time_window_days}d`);
        if (meta) meta.textContent = metaBits.join(' | ');

        const visible = cachedSuggestions.filter((item) => {
          const soNum = (item.so_num || '').toString().trim();
          if (!soNum) return false;
          const length = Number(item.total_length_ft || 0);
          if (selectedOrders.has(soNum)) return true;
          return length <= remaining;
        });

        if (!visible.length) {
          renderEmpty('No nearby draft-scope orders fit in the remaining trailer space.');
          updateSubmitState();
          updateUtilizationUI();
          return;
        }

        visible.forEach((item) => {
          const soNum = (item.so_num || '').toString().trim();
          if (!soNum) return;

          const row = document.createElement('label');
          row.className = 'manual-order-item checkbox';

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.name = 'so_nums';
          checkbox.value = soNum;
          checkbox.checked = selectedOrders.has(soNum);
          checkbox.addEventListener('change', () => {
            const normalized = normalizeOrder(item);
            if (checkbox.checked) {
              const remainingNow = capacity ? Math.max(capacity - (baseUsed + getSelectedTotalFt()), 0) : 0;
              if (Number(normalized.total_length_ft || 0) > remainingNow) {
                checkbox.checked = false;
                return;
              }
              selectedOrders.set(soNum, normalized);
            } else {
              selectedOrders.delete(soNum);
            }
            updateSubmitState();
            updateUtilizationUI();
            renderSuggestionList();
          });

          const textWrap = document.createElement('div');
          textWrap.className = 'manual-order-text';

          const title = document.createElement('div');
          title.className = 'manual-order-title';
          const titleBits = [`#${soNum}`];
          if (item.distance_miles != null) titleBits.push(`${item.distance_miles} mi`);
          if (item.total_length_ft != null) titleBits.push(`${Number(item.total_length_ft || 0).toFixed(1)} ft`);
          title.textContent = titleBits.join(' | ');

          const metaRow = document.createElement('div');
          metaRow.className = 'manual-order-meta';
          const cust = (item.cust_name || '').toString().trim();
          const due = (item.due_date || '').toString().trim();
          const city = (item.city || '').toString().trim();
          const state = (item.state || '').toString().trim();
          const metaBitsRow = [
            cust || 'Customer',
            due ? `Due ${due}` : 'Due --',
            `${city || ''}${city && state ? ', ' : ''}${state || ''}`.trim(),
          ].filter(Boolean);
          if (item.utilization_pct != null) metaBitsRow.push(`${Math.round(item.utilization_pct || 0)}% util`);
          metaRow.textContent = metaBitsRow.join(' | ');

          textWrap.appendChild(title);
          textWrap.appendChild(metaRow);

          row.appendChild(checkbox);
          row.appendChild(textWrap);
          list.appendChild(row);
        });

        updateSubmitState();
        updateUtilizationUI();
      };

      const renderSuggestions = (payload) => {
        cachedSuggestions = Array.isArray(payload.suggestions) ? payload.suggestions : [];
        cachedSpace = payload.space || {};
        cachedParams = payload.params || {};
        selectedOrders = new Map();
        updateSubmitState();
        updateUtilizationUI();
        renderSuggestionList();
      };

      const loadSuggestions = (loadId) => {
        if (!list) return;
        setError('');
        if (meta) meta.textContent = '';
        list.innerHTML = '<div class="subtext">Loading suggestions...</div>';
        if (submitBtn) submitBtn.disabled = true;
        if (utilMeta) utilMeta.textContent = '';
        if (utilFill) utilFill.style.width = '0%';

        if (activeController) activeController.abort();
        activeController = new AbortController();

        fetch(`/loads/${loadId}/manual_add/suggestions`, { signal: activeController.signal })
          .then((response) => response.json().then((data) => ({ ok: response.ok, data })))
          .then(({ ok, data }) => {
            if (!ok) {
              throw new Error((data && data.error) || 'Suggestion lookup failed.');
            }
            renderSuggestions(data || {});
          })
          .catch((err) => {
            if (err && err.name === 'AbortError') return;
            renderEmpty('Suggestion lookup failed. Try again.');
          });
      };

      const openModal = (loadId) => {
        activeLoadId = loadId;
        modal.classList.remove('hidden');
        loadSuggestions(loadId);
      };

      manualAddApi = { open: openModal, close: closeModal };

      if (closeButton) closeButton.addEventListener('click', closeModal);
      if (cancelButton) cancelButton.addEventListener('click', closeModal);

      modal.addEventListener('click', (event) => {
        if (event.target === modal) {
          closeModal();
        }
      });

      document.addEventListener('keydown', (event) => {
        if (event.key !== 'Escape') return;
        if (modal.classList.contains('hidden')) return;
        closeModal();
      });

      if (form) {
        form.addEventListener('submit', (event) => {
          event.preventDefault();
          setError('');
          if (!activeLoadId) return;

          const selected = Array.from(modal.querySelectorAll('input[name=\"so_nums\"]:checked')).map((node) => node.value);
          if (!selected.length) return;

          const confirmMsg = 'Convert this load to MANUAL, add the selected orders, and re-optimize remaining orders?';
          if (!window.confirm(confirmMsg)) return;

          if (submitBtn) submitBtn.disabled = true;
          const formData = new FormData();
          selected.forEach((soNum) => formData.append('so_nums', soNum));

          fetch(`/loads/${activeLoadId}/manual_add`, { method: 'POST', body: formData })
            .then((response) => response.json().then((data) => ({ ok: response.ok, data })))
            .then(({ ok, data }) => {
              if (!ok) {
                throw new Error((data && data.error) || 'Unable to add orders.');
              }
              const url = (data && data.redirect_url) || window.location.href;
              window.location.assign(url);
            })
            .catch((err) => {
              setError((err && err.message) || 'Unable to add orders. Try again.');
              updateSubmitState();
            });
        });
      }
    }

    function initLoadsPlantCards() {
      const container = document.querySelector('.loads-plant-cards');
      if (!container) return;
      const storageKey = 'loads-last-plants';
      container.querySelectorAll('[data-plant]').forEach((card) => {
        card.addEventListener('click', () => {
          const plant = (card.dataset.plant || '').trim().toUpperCase();
          if (!plant) return;

          const url = new URL(window.location.href);
          const params = url.searchParams;
          const currentPlantsParam = (params.get('plants') || '').trim().toUpperCase();
          const isAllMode = !currentPlantsParam || currentPlantsParam === 'ALL';

          if (plant === 'ALL') {
            if (isAllMode) {
              const last = (window.localStorage.getItem(storageKey) || '').trim().toUpperCase();
              if (last && last !== 'ALL') {
                params.set('plants', last);
              } else {
                params.delete('plants');
              }
            } else {
              window.localStorage.setItem(storageKey, currentPlantsParam);
              params.delete('plants');
            }
          } else {
            const selected = new Set(
              (params.get('plants') || '')
                .split(',')
                .map((value) => value.trim().toUpperCase())
                .filter(Boolean)
            );

            if (isAllMode) selected.clear();

            if (selected.has(plant)) {
              selected.delete(plant);
            } else {
              selected.add(plant);
            }

            if (!selected.size) {
              params.delete('plants');
              window.localStorage.removeItem(storageKey);
            } else {
              const next = Array.from(selected).join(',');
              params.set('plants', next);
              window.localStorage.setItem(storageKey, next);
            }
          }

          url.search = params.toString();
          window.location.assign(url.toString());
        });
      });
    }

    initManualLoadModal();
    initManualAddModal();
    initLoadsPlantCards();
    bindManualAddButtons();

  </script>
{% endblock %}
