{% extends "base.html" %}

{% block content %}
  <section class="settings-page">
    <header class="settings-command-hero">
      <div class="settings-command-title-wrap">
        <div class="settings-command-title-row">
          <span class="material-symbols-outlined">tune</span>
          <h1>Settings</h1>
        </div>
        <p class="settings-command-subtitle">Unified Admin Command Center for rates, customers, optimizer defaults, SKUs, and plant locations.</p>
      </div>
    </header>
    {% if not is_admin %}
      <div class="alert-message warning">Read-only access for Planner role.</div>
    {% endif %}

    <div class="settings-tabs">
      <a class="settings-tab{% if tab == 'overview' %} active{% endif %}" href="{{ url_for('settings', tab='overview') }}">
        <span class="material-symbols-outlined">dashboard</span>
        Command Center
      </a>
      <a class="settings-tab{% if tab == 'rates' %} active{% endif %}" href="{{ url_for('settings', tab='rates') }}">
        <span class="material-symbols-outlined">payments</span>
        Rates
      </a>
      <a class="settings-tab{% if tab == 'skus' %} active{% endif %}" href="{{ url_for('settings', tab='skus') }}">
        <span class="material-symbols-outlined">barcode</span>
        SKUs
      </a>
    </div>

    <div class="settings-content">
      {% if tab == 'overview' %}
        <div class="settings-command-grid">
          <article class="content-block settings-command-card settings-command-card-span-6 settings-card-rates" style="order: 1;">
            <div class="content-header settings-content-header settings-panel-header">
              <div class="settings-panel-title">
                <span class="material-symbols-outlined">payments</span>
                <div>
                  <h2>Rates Overview</h2>
                  <p class="muted">Global freight assumptions used in optimization and costing.</p>
                </div>
              </div>
              <div class="settings-card-actions">
                <a class="settings-card-btn settings-card-btn-secondary" href="{{ url_for('settings', tab='rates') }}">Edit Matrix</a>
                {% if is_admin %}
                  <button class="settings-card-btn settings-card-btn-primary" type="submit" form="rates-overview-form">Save Metrics</button>
                {% endif %}
              </div>
            </div>
            <form class="settings-mini-form" id="rates-overview-form" method="post" action="{{ url_for('save_global_metrics') }}">
              <input type="hidden" name="tab" value="overview">
              <div class="settings-rate-grid">
                <label class="settings-rate-tile">
                  <span class="settings-rate-label">Stop Fee</span>
                  <div class="settings-rate-input-wrap">
                    <span class="settings-rate-prefix">$</span>
                    <input class="settings-rate-input" type="number" step="0.01" min="0" name="stop_fee" value="{{ '%.2f' | format(global_rate_metrics.stop_fee or 0) }}" {% if not is_admin %}disabled{% endif %}>
                  </div>
                  <small>Applied per additional stop</small>
                </label>
                <label class="settings-rate-tile">
                  <span class="settings-rate-label">Load Minimum</span>
                  <div class="settings-rate-input-wrap">
                    <span class="settings-rate-prefix">$</span>
                    <input class="settings-rate-input" type="number" step="0.01" min="0" name="load_minimum" value="{{ '%.2f' | format(global_rate_metrics.load_minimum or 0) }}" {% if not is_admin %}disabled{% endif %}>
                  </div>
                  <small>Global floor per load</small>
                </label>
                <label class="settings-rate-tile">
                  <span class="settings-rate-label">Fuel Surcharge</span>
                  <div class="settings-rate-input-wrap">
                    <span class="settings-rate-prefix">$</span>
                    <input class="settings-rate-input" type="number" step="0.01" min="0" name="fuel_surcharge" value="{{ '%.2f' | format(global_rate_metrics.fuel_surcharge or 0) }}" {% if not is_admin %}disabled{% endif %}>
                    <span class="settings-rate-suffix">/mi</span>
                  </div>
                  <small>Added to state rate per mile</small>
                </label>
              </div>
            </form>
          </article>

          <article class="content-block settings-command-card settings-command-card-span-6 settings-card-stop-colors" style="order: 99;">
            <div class="content-header settings-content-header settings-panel-header">
              <div class="settings-panel-title">
                <span class="material-symbols-outlined">palette</span>
                <div>
                  <h2>Stop Colors</h2>
                  <p class="muted">Default color map for stops 1-12 across manifest dots and stacking schematic blocks.</p>
                </div>
              </div>
              {% if is_admin %}
                <div class="settings-card-actions">
                  <button class="settings-card-btn settings-card-btn-primary" type="submit" form="stop-colors-form">Save Colors</button>
                </div>
              {% endif %}
            </div>
            <form class="settings-stop-color-form" id="stop-colors-form" method="post" action="{{ url_for('save_stop_colors') }}">
              <input type="hidden" name="tab" value="overview">
              <div class="settings-stop-color-grid">
                {% for row in stop_color_rows %}
                  <label class="settings-stop-color-row" data-stop-color-row>
                    <span class="settings-stop-color-label">Stop {{ row.sequence }}</span>
                    <span class="settings-stop-color-swatch" data-stop-color-swatch style="--stop-color: {{ row.color }};"></span>
                    <input
                      class="settings-stop-color-picker"
                      type="color"
                      name="stop_color_{{ row.sequence }}"
                      value="{{ row.color }}"
                      data-stop-color-input
                      {% if not is_admin %}disabled{% endif %}
                    >
                    <input
                      class="table-input settings-stop-color-hex"
                      type="text"
                      value="{{ row.color }}"
                      data-stop-color-hex
                      maxlength="7"
                      pattern="#[0-9A-Fa-f]{6}"
                      {% if not is_admin %}disabled{% endif %}
                    >
                  </label>
                {% endfor %}
              </div>
            </form>
          </article>

          <article class="content-block settings-command-card settings-command-card-span-6 settings-card-plants" style="order: 3;">
            <div class="content-header settings-content-header settings-panel-header">
              <div class="settings-panel-title">
                <span class="material-symbols-outlined">factory</span>
                <div>
                  <h2>Plant Locations</h2>
                  <p class="muted">Editable plant registry.</p>
                </div>
              </div>
            </div>
            <div class="table-container table-container-compact settings-table-shell">
              <table class="settings-table inline-edit-table" id="overview-plants-table" data-save="/plants/save">
                <thead>
                  <tr>
                    <th>Plant</th>
                    <th>Name</th>
                    <th>Lat</th>
                    <th>Lng</th>
                    <th>Address</th>
                  </tr>
                </thead>
                <tbody>
                  {% for plant in plants_data %}
                    <tr data-id="{{ plant.id }}">
                      <td><input class="table-input" data-field="plant_code" value="{{ plant.plant_code }}" {% if not is_admin %}disabled{% endif %}></td>
                      <td><input class="table-input" data-field="name" value="{{ plant.name }}" {% if not is_admin %}disabled{% endif %}></td>
                      <td><input class="table-input" data-field="lat" data-type="float" type="number" step="0.0001" value="{{ '%.4f' | format(plant.lat) if plant.lat is not none else '' }}" {% if not is_admin %}disabled{% endif %}></td>
                      <td><input class="table-input" data-field="lng" data-type="float" type="number" step="0.0001" value="{{ '%.4f' | format(plant.lng) if plant.lng is not none else '' }}" {% if not is_admin %}disabled{% endif %}></td>
                      <td><input class="table-input" data-field="address" value="{{ plant.address or '' }}" {% if not is_admin %}disabled{% endif %}></td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </article>

          <article class="content-block settings-command-card settings-command-card-span-6 settings-card-defaults" style="order: 4;">
            <div class="content-header settings-content-header settings-panel-header">
              <div class="settings-panel-title">
                <span class="material-symbols-outlined">tune</span>
                <div>
                  <h2>Optimizer Defaults</h2>
                  <p class="muted">Primary defaults used to pre-fill optimization on Orders.</p>
                </div>
              </div>
              {% if is_admin %}
                <div class="settings-card-actions">
                  <button class="settings-card-btn settings-card-btn-primary" type="submit" form="optimizer-defaults-form">Save Defaults</button>
                </div>
              {% endif %}
            </div>
            <form class="settings-defaults-form" id="optimizer-defaults-form" method="post" action="{{ url_for('save_optimizer_defaults') }}">
              <input type="hidden" name="tab" value="overview">
              <div class="table-container table-container-compact settings-table-shell">
                <table class="settings-table settings-defaults-table">
                  <thead>
                    <tr>
                      <th>Parameter</th>
                      <th>Default Value</th>
                      <th>Notes</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>Trailer Type</td>
                      <td>
                        <select class="select-field settings-default-input" name="trailer_type" {% if not is_admin %}disabled{% endif %}>
                          {% for trailer_option in trailer_profile_options %}
                            <option value="{{ trailer_option.value }}" {% if optimizer_defaults.trailer_type == trailer_option.value %}selected{% endif %}>{{ trailer_option.label }}</option>
                          {% endfor %}
                        </select>
                      </td>
                      <td class="settings-default-note">Primary profile for capacity planning</td>
                    </tr>
                    <tr>
                      <td>Capacity (ft)</td>
                      <td><input class="select-field settings-default-input" type="number" min="1" step="0.1" name="capacity_feet" value="{{ optimizer_defaults.capacity_feet }}" {% if not is_admin %}disabled{% endif %}></td>
                      <td class="settings-default-note">Target trailer length capacity.</td>
                    </tr>
                    <tr>
                      <td>Time Window (days)</td>
                      <td><input class="select-field settings-default-input" type="number" min="0" step="1" name="time_window_days" value="{{ optimizer_defaults.time_window_days }}" {% if not is_admin %}disabled{% endif %}></td>
                      <td class="settings-default-note">How early orders can be consolidated.</td>
                    </tr>
                    <tr>
                      <td>Geo Search Radius</td>
                      <td><input class="select-field settings-default-input" type="number" min="0" step="1" name="geo_radius" value="{{ optimizer_defaults.geo_radius }}" {% if not is_admin %}disabled{% endif %}></td>
                      <td class="settings-default-note">Maximum distance for order consolidation.</td>
                    </tr>
                    <tr>
                      <td>Max Detour (%)</td>
                      <td><input class="select-field settings-default-input" type="number" min="0" step="1" name="max_detour_pct" value="{{ optimizer_defaults.max_detour_pct }}" {% if not is_admin %}disabled{% endif %}></td>
                      <td class="settings-default-note">Route compatibility tolerance.</td>
                    </tr>
                    <tr>
                      <td>Stack Overflow Max Height</td>
                      <td><input class="select-field settings-default-input" type="number" min="0" step="1" name="stack_overflow_max_height" value="{{ optimizer_defaults.stack_overflow_max_height or 5 }}" {% if not is_admin %}disabled{% endif %}></td>
                      <td class="settings-default-note">Allows one overflow unit on a full stack when item max-stack is at least this value (0 disables).</td>
                    </tr>
                    <tr>
                      <td>Back Overhang Allowance (ft)</td>
                      <td><input class="select-field settings-default-input" type="number" min="0" step="0.1" name="max_back_overhang_ft" value="{{ optimizer_defaults.max_back_overhang_ft or 4 }}" {% if not is_admin %}disabled{% endif %}></td>
                      <td class="settings-default-note">Allowed overhang off trailer back (left side in schematic) before hard capacity violation.</td>
                    </tr>
                    <tr>
                      <td>Upper Deck Two-Across Max Length (ft)</td>
                      <td><input class="select-field settings-default-input" type="number" min="0" step="0.1" name="upper_two_across_max_length_ft" value="{{ optimizer_defaults.upper_two_across_max_length_ft or 7 }}" {% if not is_admin %}disabled{% endif %}></td>
                      <td class="settings-default-note">For step decks, items at or below this length can be treated as 2-across on upper deck to add capacity. Upper deck stacking still uses flatbed max stack values.</td>
                    </tr>
                    <tr>
                      <td>Upper Deck Exception Max Length (ft)</td>
                      <td><input class="select-field settings-default-input" type="number" min="0" step="0.1" name="upper_deck_exception_max_length_ft" value="{{ optimizer_defaults.upper_deck_exception_max_length_ft or 16 }}" {% if not is_admin %}disabled{% endif %}></td>
                      <td class="settings-default-note">Selected categories can be placed on step-deck upper deck up to this length.</td>
                    </tr>
                    <tr>
                      <td>Upper Deck Exception Overhang Allowance (ft)</td>
                      <td><input class="select-field settings-default-input" type="number" min="0" step="0.1" name="upper_deck_exception_overhang_allowance_ft" value="{{ optimizer_defaults.upper_deck_exception_overhang_allowance_ft or 6 }}" {% if not is_admin %}disabled{% endif %}></td>
                      <td class="settings-default-note">Maximum upper-deck back overhang allowed for exception-eligible stacks.</td>
                    </tr>
                    <tr>
                      <td>Upper Deck Exception Categories</td>
                      <td>
                        {% set selected_exception_categories = optimizer_defaults.upper_deck_exception_categories or ['USA', 'UTA'] %}
                        <div class="settings-inline-checkboxes">
                          {% for category in optimizer_exception_category_options %}
                            <label class="settings-inline-check">
                              <input type="checkbox" name="upper_deck_exception_categories" value="{{ category }}" {% if category in selected_exception_categories %}checked{% endif %} {% if not is_admin %}disabled{% endif %}>
                              <span>{{ category }}</span>
                            </label>
                          {% endfor %}
                        </div>
                      </td>
                      <td class="settings-default-note">Upper-deck exception applies only when all items in a stack are in selected categories.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </form>
          </article>

          <article class="content-block settings-command-card settings-command-card-span-6 settings-card-trailers" style="order: 98;">
            <div class="content-header settings-content-header settings-panel-header">
              <div class="settings-panel-title">
                <span class="material-symbols-outlined">local_shipping</span>
                <div>
                  <h2>Trailer Types</h2>
                  <p class="muted">Profiles available in the load schematic and optimizer controls.</p>
                </div>
              </div>
            </div>
            <div class="table-container table-container-compact settings-table-shell">
              <table class="settings-table settings-defaults-table settings-trailer-types-table">
                <thead>
                  <tr>
                    <th>Trailer</th>
                    <th>Total (ft)</th>
                    <th>Lower (ft)</th>
                    <th>Upper (ft)</th>
                  </tr>
                </thead>
                <tbody>
                  {% for trailer_option in trailer_profile_options %}
                    <tr>
                      <td>{{ trailer_option.label }}</td>
                      <td>{{ trailer_option.capacity | round(1) }}</td>
                      <td>{{ trailer_option.lower | round(1) }}</td>
                      <td>{{ trailer_option.upper | round(1) }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </article>

          <article class="content-block settings-command-card settings-command-card-span-6 settings-card-grades" style="order: 2;">
            <div class="content-header settings-content-header settings-panel-header">
              <div class="settings-panel-title">
                <span class="material-symbols-outlined">speed</span>
                <div>
                <h2>Utilization Grades</h2>
                <p class="muted">Editable grade thresholds.</p>
                </div>
              </div>
              {% if is_admin %}
                <div class="settings-card-actions">
                  <button class="settings-card-btn settings-card-btn-primary" type="submit" form="util-grades-form">Save Grades</button>
                </div>
              {% endif %}
            </div>
            <form id="util-grades-form" method="post" action="{{ url_for('save_utilization_grades') }}">
              <input type="hidden" name="tab" value="overview">
              <div class="util-grade-list">
                {% for row in util_grade_thresholds %}
                  {% set grade_name = 'Excellent' if row.grade == 'A' else ('Good' if row.grade == 'B' else ('Average' if row.grade == 'C' else ('Warning' if row.grade == 'D' else 'Critical')) ) %}
                  {% if row.grade in ['A', 'B', 'C'] %}
                    <label class="util-grade-row util-{{ row.grade | lower }}">
                      <span class="util-grade-main">
                        <span class="grade-pill">{{ row.grade }}</span>
                        <span class="util-grade-name">{{ grade_name }}</span>
                      </span>
                      <span class="util-grade-threshold">
                        <input class="select-field util-grade-input" type="number" min="0" max="100" step="1" name="grade_{{ row.grade | lower }}_min" value="{{ row.min_pct }}" {% if not is_admin %}disabled{% endif %}>
                        <span>%+</span>
                      </span>
                    </label>
                  {% elif row.grade == 'D' %}
                    <label class="util-grade-row util-{{ row.grade | lower }}">
                      <span class="util-grade-main">
                        <span class="grade-pill">{{ row.grade }}</span>
                        <span class="util-grade-name">{{ grade_name }}</span>
                      </span>
                      <span class="util-grade-threshold">
                        {% if is_admin %}
                          <input class="select-field util-grade-input" type="number" min="0" max="100" step="1" name="grade_d_min" data-grade-d-input value="{{ row.min_pct }}">
                        {% else %}
                          <span>{{ row.min_pct }}</span>
                        {% endif %}
                        <span>%+</span>
                      </span>
                    </label>
                  {% else %}
                    <div class="util-grade-row util-f">
                      <span class="util-grade-main">
                        <span class="grade-pill">{{ row.grade }}</span>
                        <span class="util-grade-name">{{ grade_name }}</span>
                      </span>
                      <span class="util-grade-threshold">
                        {% if is_admin %}
                          <input class="select-field util-grade-input" type="number" min="0" max="99" step="1" name="grade_f_max" data-grade-f-input value="{{ row.f_max if row.f_max is not none else 0 }}">
                        {% else %}
                          <span>{{ row.f_max if row.f_max is not none else 0 }}</span>
                        {% endif %}
                        <span>% max</span>
                      </span>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            </form>
          </article>

          <article class="content-block settings-command-card settings-command-card-wide settings-card-strategic" style="order: 5;">
            <div class="content-header settings-content-header settings-panel-header">
              <div class="settings-panel-title">
                <span class="material-symbols-outlined">star</span>
                <div>
                  <h2>Customer Specific Rules</h2>
                  <p class="muted">Customer-level defaults for optimization and load shaping.</p>
                </div>
              </div>
              {% if is_admin %}
                <div class="settings-card-actions">
                  <button class="settings-card-btn settings-card-btn-primary" type="submit" form="strategic-customers-form">Save Definitions</button>
                </div>
              {% endif %}
            </div>
            <form class="form-grid settings-strategic-form" id="strategic-customers-form" method="post" action="{{ url_for('save_planning_tools') }}">
              <input type="hidden" name="tab" value="overview">
              <textarea class="settings-textarea-hidden" name="strategic_customers" data-strategic-hidden hidden>{{ strategic_customers_raw or '' }}</textarea>
              <div class="strategic-editor">
                <div class="strategic-editor-head">
                  <span class="muted">Pattern matching is case-insensitive substring logic. Customer Flex Days overrides global optimizer flex for that customer (leave blank to use global). Tractor Supply orders with 16ft+ cargo are auto-assigned to 51' Wedge.</span>
                  {% if is_admin %}
                    <button class="settings-card-btn settings-card-btn-secondary settings-inline-btn" type="button" data-strategic-add>
                      <span class="material-symbols-outlined">add</span>
                      Add Row
                    </button>
                  {% endif %}
                </div>
                <div class="table-container table-container-compact settings-table-shell">
                  <table class="settings-table settings-strategic-table">
                    <thead>
                      <tr>
                        <th>Customer Label</th>
                        <th>Match Patterns</th>
                        <th>Customer Flex Days</th>
                        <th>No Mix</th>
                        <th>Default 51' Wedge</th>
                        <th>Requires Return Trip</th>
                        <th>Ignore for Optimization</th>
                        <th>Include in Optimizer Workbench</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody data-strategic-rows>
                      {% if strategic_customers and strategic_customers | length %}
                        {% for entry in strategic_customers %}
                          <tr class="strategic-row" data-strategic-row>
                            <td>
                              <input class="table-input" type="text" data-strategic-label placeholder="Customer label" value="{{ entry.label }}" {% if not is_admin %}disabled{% endif %}>
                            </td>
                            <td>
                              <input class="table-input strategic-pattern-input" type="text" data-strategic-patterns placeholder="Pattern1, Pattern2" value="{{ entry.patterns | join(', ') }}" {% if not is_admin %}disabled{% endif %}>
                            </td>
                            <td>
                              <input class="table-input strategic-flex-input" type="number" min="0" step="1" data-strategic-flex placeholder="Use Global" value="{{ entry.default_due_date_flex_days if entry.default_due_date_flex_days is not none else '' }}" {% if not is_admin %}disabled{% endif %}>
                            </td>
                            <td class="strategic-check-cell">
                              <input class="strategic-checkbox" type="checkbox" data-strategic-no-mix {% if entry.no_mix %}checked{% endif %} {% if not is_admin %}disabled{% endif %}>
                            </td>
                            <td class="strategic-check-cell">
                              <input class="strategic-checkbox" type="checkbox" data-strategic-wedge {% if entry.default_wedge_51 %}checked{% endif %} {% if not is_admin %}disabled{% endif %}>
                            </td>
                            <td class="strategic-check-cell">
                              <input class="strategic-checkbox" type="checkbox" data-strategic-return {% if entry.requires_return_to_origin %}checked{% endif %} {% if not is_admin %}disabled{% endif %}>
                            </td>
                            <td class="strategic-check-cell">
                              <input class="strategic-checkbox" type="checkbox" data-strategic-ignore-opt {% if entry.ignore_for_optimization %}checked{% endif %} {% if not is_admin %}disabled{% endif %}>
                            </td>
                            <td class="strategic-check-cell">
                              <input class="strategic-checkbox" type="checkbox" data-strategic-workbench {% if entry.include_in_optimizer_workbench %}checked{% endif %} {% if not is_admin %}disabled{% endif %}>
                            </td>
                            <td class="strategic-remove-cell">
                              {% if is_admin %}
                                <button class="btn-ghost btn-icon" type="button" data-strategic-remove title="Remove row">
                                  <span class="material-symbols-outlined">close</span>
                                </button>
                              {% else %}
                                <span class="muted">-</span>
                              {% endif %}
                            </td>
                          </tr>
                        {% endfor %}
                      {% else %}
                        <tr class="strategic-row" data-strategic-row>
                          <td>
                            <input class="table-input" type="text" data-strategic-label placeholder="Customer label" {% if not is_admin %}disabled{% endif %}>
                          </td>
                          <td>
                            <input class="table-input strategic-pattern-input" type="text" data-strategic-patterns placeholder="Pattern1, Pattern2" {% if not is_admin %}disabled{% endif %}>
                          </td>
                          <td>
                            <input class="table-input strategic-flex-input" type="number" min="0" step="1" data-strategic-flex placeholder="Use Global" value="" {% if not is_admin %}disabled{% endif %}>
                          </td>
                          <td class="strategic-check-cell">
                            <input class="strategic-checkbox" type="checkbox" data-strategic-no-mix {% if not is_admin %}disabled{% endif %}>
                          </td>
                          <td class="strategic-check-cell">
                            <input class="strategic-checkbox" type="checkbox" data-strategic-wedge {% if not is_admin %}disabled{% endif %}>
                          </td>
                          <td class="strategic-check-cell">
                            <input class="strategic-checkbox" type="checkbox" data-strategic-return {% if not is_admin %}disabled{% endif %}>
                          </td>
                          <td class="strategic-check-cell">
                            <input class="strategic-checkbox" type="checkbox" data-strategic-ignore-opt {% if not is_admin %}disabled{% endif %}>
                          </td>
                          <td class="strategic-check-cell">
                            <input class="strategic-checkbox" type="checkbox" data-strategic-workbench checked {% if not is_admin %}disabled{% endif %}>
                          </td>
                          <td class="strategic-remove-cell">
                            {% if is_admin %}
                              <button class="btn-ghost btn-icon" type="button" data-strategic-remove title="Remove row">
                                <span class="material-symbols-outlined">close</span>
                              </button>
                            {% else %}
                              <span class="muted">-</span>
                            {% endif %}
                          </td>
                        </tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </div>
            </form>
            <div class="settings-chip-list strategic-chip-list" data-strategic-chip-list>
              {% if strategic_customers and strategic_customers | length %}
                {% for entry in strategic_customers %}
                  <span class="meta-chip strategic-chip">
                    <strong>{{ entry.label }}</strong>
                    - {{ entry.patterns | join(', ') }}
                    {% if entry.default_due_date_flex_days is not none %}
                      - Flex {{ entry.default_due_date_flex_days }}d
                    {% endif %}
                    {% if entry.no_mix %}- No Mix{% endif %}
                    {% if entry.default_wedge_51 %}- 51' Wedge{% endif %}
                    {% if entry.requires_return_to_origin %}- Return Trip{% endif %}
                    {% if entry.ignore_for_optimization %}- Ignored in Auto Optimize{% endif %}
                    {% if not entry.include_in_optimizer_workbench %}- Hidden in Workbench{% endif %}
                  </span>
                {% endfor %}
              {% endif %}
            </div>
          </article>

          <article class="content-block settings-command-card settings-command-card-wide settings-card-trailer-rules" style="order: 6;">
            <div class="content-header settings-content-header settings-panel-header">
              <div class="settings-panel-title">
                <span class="material-symbols-outlined">local_shipping</span>
                <div>
                  <h2>Trailer Assignment Rules</h2>
                  <p class="muted">Global trailer logic used by the planner and auto-assignment flow.</p>
                </div>
              </div>
              {% if is_admin %}
                <div class="settings-card-actions">
                  <button class="settings-card-btn settings-card-btn-primary" type="submit" form="trailer-rules-form">Save Trailer Rules</button>
                </div>
              {% endif %}
            </div>
            <form class="settings-defaults-form" id="trailer-rules-form" method="post" action="{{ url_for('save_planning_tools') }}">
              <input type="hidden" name="tab" value="overview">
              <input type="hidden" name="trailer_rules_form" value="1">
              <div class="table-container table-container-compact settings-table-shell">
                <table class="settings-table settings-defaults-table">
                  <thead>
                    <tr>
                      <th>Trailer Rule</th>
                      <th>Setting</th>
                      <th>Operational Note</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>LIVESTOCK Uses 51' Wedge</td>
                      <td>
                        <label class="checkbox-pill">
                          <input type="checkbox" name="livestock_wedge_enabled" value="1" {% if trailer_assignment_rules.livestock_wedge_enabled %}checked{% endif %} {% if not is_admin %}disabled{% endif %}>
                          <span>Enabled for all customers</span>
                        </label>
                      </td>
                      <td class="settings-default-note">Any order with SKU category matching LIVESTOCK will be assigned to a WEDGE trailer profile.</td>
                    </tr>
                    <tr>
                      <td>Auto Assign HOTSHOT</td>
                      <td>
                        <label class="checkbox-pill">
                          <input type="checkbox" name="auto_assign_hotshot_enabled" value="1" {% if trailer_assignment_rules.auto_assign_hotshot_enabled %}checked{% endif %} {% if not is_admin %}disabled{% endif %}>
                          <span>Enabled</span>
                        </label>
                      </td>
                      <td class="settings-default-note">When enabled, any non-wedge load that fits on HOTSHOT is auto-assigned to HOTSHOT.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </form>
          </article>

          <article class="content-block settings-command-card settings-command-card-wide settings-card-registry" style="order: 7;">
            <div class="content-header settings-content-header settings-panel-header">
              <div class="settings-panel-title">
                <span class="material-symbols-outlined">inventory_2</span>
                <div>
                  <h2>Master SKU List (Recent)</h2>
                  <p class="muted">Top 3 most recently added SKUs.</p>
                </div>
              </div>
              <div class="settings-card-actions">
                <a class="settings-card-btn settings-card-btn-secondary" href="{{ url_for('settings', tab='skus') }}">Full SKU List</a>
              </div>
            </div>
            {% if recent_specs %}
              <div class="table-container table-container-compact settings-table-shell">
                <table class="settings-table inline-edit-table" id="overview-sku-table" data-save="/skus/save">
                  <thead>
                    <tr>
                      <th>SKU</th>
                      <th>Description</th>
                      <th>Category</th>
                      <th>Length</th>
                      <th>Step</th>
                      <th>Flat</th>
                      <th>Added</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for spec in recent_specs[:3] %}
                      <tr data-id="{{ spec.id }}">
                        <td><input class="table-input" data-field="sku" value="{{ spec.sku }}" {% if not is_admin %}disabled{% endif %}></td>
                        <td><input class="table-input" data-field="description" value="{{ spec.description or '' }}" {% if not is_admin %}disabled{% endif %}></td>
                        <td><input class="table-input" data-field="category" value="{{ spec.category or '' }}" {% if not is_admin %}disabled{% endif %}></td>
                        <td><input class="table-input" data-field="length_with_tongue_ft" data-type="float" type="number" step="0.1" value="{{ spec.length_with_tongue_ft }}" {% if not is_admin %}disabled{% endif %}></td>
                        <td><input class="table-input" data-field="max_stack_step_deck" data-type="int" type="number" min="1" value="{{ spec.max_stack_step_deck }}" {% if not is_admin %}disabled{% endif %}></td>
                        <td><input class="table-input" data-field="max_stack_flat_bed" data-type="int" type="number" min="1" value="{{ spec.max_stack_flat_bed }}" {% if not is_admin %}disabled{% endif %}></td>
                        <td><span class="muted">{{ (spec.added_at or spec.created_at) | est_datetime if (spec.added_at or spec.created_at) else '' }}</span></td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p>No SKU specs yet.</p>
            {% endif %}
          </article>
        </div>
      {% elif tab == 'rates' %}
        <div class="content-block settings-rates-tab">
          <div class="content-header settings-content-header">
            <div>
              <h2>Freight Rates</h2>
              <p class="muted">Update base lane rates by destination state. Estimated freight applies stop fee, load minimum, and fuel surcharge automatically.</p>
            </div>
            <div class="settings-header-chips">
              <span class="meta-chip">{{ rate_plants | length }} Plants</span>
              <span class="meta-chip">{{ rate_states | length }} Destinations</span>
              <span class="meta-chip">{{ rates | length }} Lanes</span>
            </div>
          </div>
          <div class="rate-context-shell" id="rate-context-shell">
            <div class="rate-context-header">
              <span class="meta-label">Rate Table Contexts</span>
              <span class="muted">Use the context tabs to preview planned rate-table modes. All contexts currently use the live DEFAULT matrix.</span>
            </div>
            <div class="settings-defaults-form">
              <div class="rate-context-tabs" role="tablist" aria-label="Rate table contexts">
                <button class="rate-context-tab is-active" type="button" role="tab" aria-selected="true" data-rate-context-target="default">System Default</button>
                <button class="rate-context-tab" type="button" role="tab" aria-selected="false" data-rate-context-target="ryder">Dedicated Ryder Fleet</button>
                <button class="rate-context-tab" type="button" role="tab" aria-selected="false" data-rate-context-target="hotshot">Hotshot Trailer</button>
              </div>
              <div class="rate-context-panel is-active" data-rate-context-panel="default">
                <span class="meta-chip">Using: DEFAULT</span>
                <p class="settings-default-note">Current production matrix. Cost logic uses this table today.</p>
              </div>
              <div class="rate-context-panel" data-rate-context-panel="ryder" hidden>
                <span class="meta-chip">Planned Table: DEDICATED RYDER FLEET</span>
                <p class="settings-default-note">Placeholder context for dedicated fleet rating. Wiring to cost engine comes later.</p>
              </div>
              <div class="rate-context-panel" data-rate-context-panel="hotshot" hidden>
                <span class="meta-chip">Planned Table: HOTSHOT TRAILER TYPES</span>
                <p class="settings-default-note">Placeholder context for future hotshot-specific rate tables.</p>
              </div>
            </div>
          </div>
          <div class="rates-toolbar">
            <div class="search-field">
              <span class="material-symbols-outlined">search</span>
              <input id="rate-search" type="text" placeholder="Search destination row..." />
            </div>
            <div class="muted">Tip: edit a cell and click outside to save.</div>
          </div>
          <div class="rate-assumptions">
            <div class="assumption-card">
              <span class="meta-label">Stop Fee</span>
              <span class="assumption-value">${{ '%.2f' | format(global_rate_metrics.stop_fee or 0) }}</span>
              <span class="assumption-note">Applied per stop</span>
            </div>
            <div class="assumption-card">
              <span class="meta-label">Load Minimum</span>
              <span class="assumption-value">${{ '%.2f' | format(global_rate_metrics.load_minimum or 0) }}</span>
              <span class="assumption-note">Applied per load</span>
            </div>
            <div class="assumption-card assumption-card-editable">
              <span class="meta-label">Fuel Surcharge</span>
              {% if is_admin %}
                <label class="rate-input-wrap assumption-input-wrap" for="fuel-surcharge-input">
                  <span class="currency-prefix">$</span>
                  <input
                    id="fuel-surcharge-input"
                    class="table-input"
                    type="number"
                    step="0.01"
                    min="0"
                    value="{{ '%.2f' | format(fuel_surcharge_per_mile or 0) }}"
                    aria-label="Fuel surcharge per mile"
                  />
                </label>
              {% else %}
                <span class="assumption-value">${{ '%.2f' | format(fuel_surcharge_per_mile or 0) }}</span>
              {% endif %}
              <span class="assumption-note" id="fuel-surcharge-note">
                Applied per mile. Example: base $3.25 -> effective ${{ '%.2f' | format((3.25 + (fuel_surcharge_per_mile or 0)) | float) }}
              </span>
            </div>
          </div>
          {% if not is_admin %}
            <div class="readonly-note">Rates are read-only for planners.</div>
          {% endif %}

          {% if rate_states %}
            <div class="table-container">
              <table class="settings-table rates-matrix" id="rates-matrix">
                <thead>
                  <tr>
                    <th>Destination</th>
                    {% for plant in rate_plants %}
                      <th>{{ plant }}</th>
                    {% endfor %}
                  </tr>
                </thead>
                <tbody>
                  {% for state in rate_states %}
                    <tr>
                      <td class="matrix-label">{{ state }}</td>
                      {% for plant in rate_plants %}
                        {% set rate = rate_matrix[state][plant] %}
                        {% set rate_value = ('%.2f' | format(rate.rate_per_mile)) if rate and rate.rate_per_mile is not none else '' %}
                        <td class="rate-cell"
                            data-origin-plant="{{ plant }}"
                            data-destination-state="{{ state }}"
                            data-rate-id="{{ rate.id if rate }}"
                            data-effective-year="{{ rate.effective_year if rate }}">
                          {% if is_admin %}
                            <div class="rate-input-wrap">
                              <span class="currency-prefix">$</span>
                              <input class="table-input rate-input"
                                     type="number"
                                     step="0.01"
                                     value="{{ rate_value }}"
                                     placeholder="--" />
                            </div>
                          {% else %}
                            <span class="rate-display">
                              {% if rate %}${{ rate_value }}{% else %}-{% endif %}
                            </span>
                          {% endif %}
                        </td>
                      {% endfor %}
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p>No rates yet.</p>
          {% endif %}
          <div class="form-status" id="rates-status"></div>
        </div>
      {% elif tab == 'skus' %}
        <div class="content-block settings-skus-tab">
          <div class="content-header sku-header-row">
            <div class="sku-header-title">
              <h2>SKU Mapping & Specifications</h2>
              <a class="sku-export-btn" href="{{ url_for('export_sku_cheat_sheet') }}">
                <span class="material-symbols-outlined" aria-hidden="true">download</span>
                Download SKU Cheat Sheet (.xlsx)
              </a>
            </div>
          </div>
          <div class="content-header settings-content-header">
            <div>
              <h3>Source-Led Cheat Sheet</h3>
              <p class="muted">Open-orders item numbers and descriptions first, then mapped canonical cheat-sheet specifications.</p>
            </div>
            <div class="settings-header-chips">
              <span class="meta-chip">{{ source_led_specs | length }} Item/BIN Profiles</span>
              <span class="meta-chip">{{ source_led_unique_sku_count }} Unique Mapped SKUs</span>
              <span class="meta-chip">{{ source_led_mapped_count }} Mapped</span>
              <span class="meta-chip">{{ source_led_unmapped_count }} Unmapped</span>
              <span class="meta-chip">{{ source_led_missing_spec_count }} Missing Spec</span>
            </div>
          </div>
          <div class="rates-toolbar">
            <div class="search-field">
              <span class="material-symbols-outlined">search</span>
              <input id="source-led-search" type="text" data-source-led-search placeholder="Search item num, description, or mapped SKU..." />
            </div>
            <div style="display: inline-flex; align-items: center; gap: 0.6rem;">
              <button class="btn-ghost btn-xs" type="button" data-source-column-toggle aria-expanded="false" title="Show mapping columns">+ Columns</button>
              <div class="muted">This table is read-only and driven by open orders + lookup mapping.</div>
            </div>
          </div>
          {% if source_led_specs %}
            <div class="table-container">
              <table class="settings-table" id="source-led-table">
                <thead>
                  <tr>
                    <th>Item Num</th>
                    <th>Item Desc</th>
                    <th data-source-extra-col hidden>BIN</th>
                    <th data-source-extra-col hidden>Mapped SKU</th>
                    <th data-source-extra-col hidden>Mapped Description</th>
                    <th>Category</th>
                    <th>Length (ft)</th>
                    <th>Step Deck</th>
                    <th>Flat Bed</th>
                    <th>Status</th>
                    <th>Lines</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in source_led_specs %}
                    <tr data-source-row
                        data-item-num="{{ row.item_num or '' }}"
                        data-item-desc="{{ row.item_desc or '' }}"
                        data-mapped-sku="{{ row.mapped_sku or '' }}"
                        data-category="{{ row.category or '' }}">
                      <td><strong>{{ row.item_num }}</strong></td>
                      <td>{{ row.item_desc or '-' }}</td>
                      <td data-source-extra-col hidden>{{ row.bin or '-' }}</td>
                      <td data-source-extra-col hidden>{{ row.mapped_sku or '-' }}</td>
                      <td data-source-extra-col hidden>{{ row.mapped_description or '-' }}</td>
                      <td>{{ row.category or '-' }}</td>
                      <td>
                        {% if row.length_with_tongue_ft is not none %}
                          {{ '%.1f' | format(row.length_with_tongue_ft | float) }}
                        {% else %}
                          -
                        {% endif %}
                      </td>
                      <td>{{ row.max_stack_step_deck if row.max_stack_step_deck is not none else '-' }}</td>
                      <td>{{ row.max_stack_flat_bed if row.max_stack_flat_bed is not none else '-' }}</td>
                      <td>{{ row.mapping_status }}</td>
                      <td>{{ row.line_count }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p>No observed open-order items available yet. Upload orders to populate the source-led view.</p>
          {% endif %}
          <div class="content-header settings-content-header">
            <div>
              <h3>Canonical SKU Specifications</h3>
              <p class="muted">Editable canonical specs used by stack and utilization calculations.</p>
            </div>
          </div>
          <div class="sku-filter-shell">
            <div class="sku-filter-bar" id="sku-filter-panel">
              <label class="sku-filter-field sku-filter-search">
                <span>Search</span>
                <input class="select-field" type="search" data-sku-search placeholder="Search canonical SKU or description">
              </label>
              <label class="sku-filter-field">
                <span>Length (ft)</span>
                <select class="select-field" data-sku-length-filter>
                  <option value="">All Lengths</option>
                  {% for length in sku_lengths %}
                    <option value="{{ length }}">{{ length }}</option>
                  {% endfor %}
                </select>
              </label>
              <label class="sku-filter-field">
                <span>Step Deck</span>
                <select class="select-field" data-sku-step-filter>
                  <option value="">All Step Deck Values</option>
                  {% for stack_value in sku_step_decks %}
                    <option value="{{ stack_value }}">{{ stack_value }}</option>
                  {% endfor %}
                </select>
              </label>
              <label class="sku-filter-field">
                <span>Category</span>
                <select class="select-field" data-sku-category-filter>
                  <option value="">All Categories</option>
                  {% for category in sku_categories %}
                    <option value="{{ category }}">{{ category }}</option>
                  {% endfor %}
                </select>
              </label>
              <label class="sku-filter-field">
                <span>Flat Bed</span>
                <select class="select-field" data-sku-flat-filter>
                  <option value="">All Flat Bed Values</option>
                  {% for stack_value in sku_flat_beds %}
                    <option value="{{ stack_value }}">{{ stack_value }}</option>
                  {% endfor %}
                </select>
              </label>
              <button class="btn-ghost btn-xs" type="button" data-sku-filter-reset>Reset</button>
              {% if is_admin %}
                <button
                  class="btn-primary btn-xs sku-add-toggle"
                  type="button"
                  data-sku-add-toggle
                  aria-expanded="false"
                  aria-controls="sku-add-form-panel"
                >
                  Add SKU
                </button>
              {% endif %}
            </div>
          </div>
          {% if is_admin %}
            <form class="form-grid sku-add-form" id="sku-add-form-panel" method="post" action="{{ url_for('add_sku') }}" hidden>
              <label>SKU<input name="sku" type="text" required></label>
              <label>Description<input name="description" type="text"></label>
              <label>Category<input name="category" type="text" required></label>
              <label>Length w/ Tongue (ft)<input name="length_with_tongue_ft" type="number" step="0.1" required></label>
              <label>Max Stack Step Deck<input name="max_stack_step_deck" type="number" min="1" value="1" required></label>
              <label>Max Stack Flat Bed<input name="max_stack_flat_bed" type="number" min="1" value="1" required></label>
              <label>Notes<input name="notes" type="text"></label>
              <div class="form-actions">
                <button class="btn-primary" type="submit">Save SKU</button>
              </div>
            </form>
          {% else %}
            <div class="readonly-note">SKU specifications are read-only for planners.</div>
          {% endif %}

          {% if specs %}
            <div class="table-container">
              <table class="settings-table inline-edit-table" id="sku-table" data-save="/skus/save">
                <thead>
                  <tr>
                    <th>SKU</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Length (ft)</th>
                    <th>Step Deck</th>
                    <th>Flat Bed</th>
                    <th>Notes</th>
                    <th>Added</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  {% if planner_specs %}
                    <tr class="sku-group-row" data-sku-group="planner">
                      <td colspan="9">
                        <span class="sku-group-label">Planner Input SKUs</span>
                        <span class="sku-group-meta">{{ planner_specs | length }} added</span>
                      </td>
                    </tr>
                  {% endif %}
                  {% for spec in planner_specs %}
                    <tr data-id="{{ spec.id }}"
                        data-sku-row
                        data-origin="planner"
                        data-sku-value="{{ spec.sku or '' }}"
                        data-description-value="{{ spec.description or '' }}"
                        data-category-value="{{ (spec.category or '') | upper }}"
                        data-length-value="{{ spec.length_with_tongue_ft if spec.length_with_tongue_ft is not none else '' }}"
                        data-step-deck-value="{{ spec.max_stack_step_deck if spec.max_stack_step_deck is not none else '' }}"
                        data-flat-bed-value="{{ spec.max_stack_flat_bed if spec.max_stack_flat_bed is not none else '' }}">
                      <td>
                        <input class="table-input" data-field="sku" value="{{ spec.sku }}" {% if not is_admin %}disabled{% endif %}>
                      </td>
                      <td>
                        <input class="table-input" data-field="description" value="{{ spec.description or '' }}" {% if not is_admin %}disabled{% endif %}>
                      </td>
                      <td>
                        <input class="table-input" data-field="category" value="{{ spec.category }}" {% if not is_admin %}disabled{% endif %}>
                      </td>
                      <td>
                        <input class="table-input" data-field="length_with_tongue_ft" data-type="float" type="number" step="0.1" value="{{ spec.length_with_tongue_ft }}" {% if not is_admin %}disabled{% endif %}>
                      </td>
                      <td>
                        <input class="table-input" data-field="max_stack_step_deck" data-type="int" type="number" min="1" value="{{ spec.max_stack_step_deck }}" {% if not is_admin %}disabled{% endif %}>
                      </td>
                      <td>
                        <input class="table-input" data-field="max_stack_flat_bed" data-type="int" type="number" min="1" value="{{ spec.max_stack_flat_bed }}" {% if not is_admin %}disabled{% endif %}>
                      </td>
                      <td>
                        <input class="table-input" data-field="notes" value="{{ spec.notes or '' }}" {% if not is_admin %}disabled{% endif %}>
                      </td>
                      <td>
                        <span class="muted">{{ (spec.added_at or spec.created_at) | est_datetime if (spec.added_at or spec.created_at) else '' }}</span>
                      </td>
                      <td>
                        {% if is_admin %}
                          <form method="post" action="{{ url_for('delete_sku', spec_id=spec.id) }}">
                            <button class="btn-danger" type="submit">Delete</button>
                          </form>
                        {% else %}
                          <span class="muted">Read-only</span>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                  {% if system_specs %}
                    <tr class="sku-group-row sku-group-divider" data-sku-group="system">
                      <td colspan="9">
                        <span class="sku-group-label">Preloaded Cheat Sheet</span>
                        <span class="sku-group-meta">{{ system_specs | length }} items</span>
                      </td>
                    </tr>
                  {% endif %}
                  {% for spec in system_specs %}
                    <tr data-id="{{ spec.id }}"
                        data-sku-row
                        data-origin="system"
                        data-sku-value="{{ spec.sku or '' }}"
                        data-description-value="{{ spec.description or '' }}"
                        data-category-value="{{ (spec.category or '') | upper }}"
                        data-length-value="{{ spec.length_with_tongue_ft if spec.length_with_tongue_ft is not none else '' }}"
                        data-step-deck-value="{{ spec.max_stack_step_deck if spec.max_stack_step_deck is not none else '' }}"
                        data-flat-bed-value="{{ spec.max_stack_flat_bed if spec.max_stack_flat_bed is not none else '' }}">
                      <td>
                        <input class="table-input" data-field="sku" value="{{ spec.sku }}" {% if not is_admin %}disabled{% endif %}>
                      </td>
                      <td>
                        <input class="table-input" data-field="description" value="{{ spec.description or '' }}" {% if not is_admin %}disabled{% endif %}>
                      </td>
                      <td>
                        <input class="table-input" data-field="category" value="{{ spec.category }}" {% if not is_admin %}disabled{% endif %}>
                      </td>
                      <td>
                        <input class="table-input" data-field="length_with_tongue_ft" data-type="float" type="number" step="0.1" value="{{ spec.length_with_tongue_ft }}" {% if not is_admin %}disabled{% endif %}>
                      </td>
                      <td>
                        <input class="table-input" data-field="max_stack_step_deck" data-type="int" type="number" min="1" value="{{ spec.max_stack_step_deck }}" {% if not is_admin %}disabled{% endif %}>
                      </td>
                      <td>
                        <input class="table-input" data-field="max_stack_flat_bed" data-type="int" type="number" min="1" value="{{ spec.max_stack_flat_bed }}" {% if not is_admin %}disabled{% endif %}>
                      </td>
                      <td>
                        <input class="table-input" data-field="notes" value="{{ spec.notes or '' }}" {% if not is_admin %}disabled{% endif %}>
                      </td>
                      <td>
                        <span class="muted">{{ (spec.added_at or spec.created_at) | est_datetime if (spec.added_at or spec.created_at) else '' }}</span>
                      </td>
                      <td>
                        {% if is_admin %}
                          <form method="post" action="{{ url_for('delete_sku', spec_id=spec.id) }}">
                            <button class="btn-danger" type="submit">Delete</button>
                          </form>
                        {% else %}
                          <span class="muted">Read-only</span>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p>No SKU specs yet.</p>
          {% endif %}
        </div>
      {% elif tab == 'lookups' %}
        <div class="content-block">
          <div class="content-header">
            <h2>Item Lookup Rules</h2>
          </div>
          {% if is_admin %}
            <form class="form-grid" method="post" action="{{ url_for('add_lookup') }}">
              <label>Plant<input name="plant" type="text" required></label>
              <label>BIN<input name="bin" type="text" required></label>
              <label>Item Pattern<input name="item_pattern" type="text" placeholder="4X6CG%"></label>
              <label>
                SKU
                <select name="sku" required>
                  {% for spec in specs %}
                    <option value="{{ spec.sku }}">{{ spec.sku }}</option>
                  {% endfor %}
                </select>
              </label>
              <div class="form-actions">
                <button class="btn-primary" type="submit">Save Rule</button>
              </div>
            </form>
          {% else %}
            <div class="readonly-note">Lookup rules are read-only for planners.</div>
          {% endif %}

          {% if lookups %}
            <div class="table-container">
              <table class="settings-table inline-edit-table" id="lookup-table" data-save="/lookups/save">
                <thead>
                  <tr>
                    <th>Plant</th>
                    <th>BIN</th>
                    <th>Item Pattern</th>
                    <th>SKU</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  {% for lookup in lookups %}
                    <tr data-id="{{ lookup.id }}">
                      <td>
                        <input class="table-input" data-field="plant" value="{{ lookup.plant }}" {% if not is_admin %}disabled{% endif %}>
                      </td>
                      <td>
                        <input class="table-input" data-field="bin" value="{{ lookup.bin }}" {% if not is_admin %}disabled{% endif %}>
                      </td>
                      <td>
                        <input class="table-input" data-field="item_pattern" value="{{ lookup.item_pattern or '' }}" {% if not is_admin %}disabled{% endif %}>
                      </td>
                      <td>
                        <input class="table-input"
                               data-field="sku"
                               list="sku-options"
                               value="{{ lookup.sku }}"
                               {% if not is_admin %}disabled{% endif %}>
                      </td>
                      <td>
                        {% if is_admin %}
                          <form method="post" action="{{ url_for('delete_lookup', entry_id=lookup.id) }}">
                            <button class="btn-danger" type="submit">Delete</button>
                          </form>
                        {% else %}
                          <span class="muted">Read-only</span>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <datalist id="sku-options">
              {% for spec in specs %}
                <option value="{{ spec.sku }}"></option>
              {% endfor %}
            </datalist>
          {% else %}
            <p>No lookup rules yet.</p>
          {% endif %}
        </div>
      {% elif tab == 'plants' %}
        <div class="content-block">
          <div class="content-header">
            <h2>Plant Locations</h2>
          </div>
          <div class="table-container">
            <table class="settings-table inline-edit-table" id="plants-table" data-save="/plants/save">
              <thead>
                <tr>
                  <th>Plant Code</th>
                  <th>Name</th>
                  <th>Latitude</th>
                  <th>Longitude</th>
                  <th>Address</th>
                </tr>
              </thead>
              <tbody>
                {% for plant in plants_data %}
                  <tr data-id="{{ plant.id }}">
                    <td>
                      <input class="table-input" data-field="plant_code" value="{{ plant.plant_code }}" {% if not is_admin %}disabled{% endif %}>
                    </td>
                    <td>
                      <input class="table-input" data-field="name" value="{{ plant.name }}" {% if not is_admin %}disabled{% endif %}>
                    </td>
                    <td>
                      <input class="table-input" data-field="lat" data-type="float" type="number" step="0.0001" value="{{ '%.4f' | format(plant.lat) if plant.lat is not none else '' }}" {% if not is_admin %}disabled{% endif %}>
                    </td>
                    <td>
                      <input class="table-input" data-field="lng" data-type="float" type="number" step="0.0001" value="{{ '%.4f' | format(plant.lng) if plant.lng is not none else '' }}" {% if not is_admin %}disabled{% endif %}>
                    </td>
                    <td>
                      <input class="table-input" data-field="address" value="{{ plant.address or '' }}" {% if not is_admin %}disabled{% endif %}>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% elif tab == 'planning_tools' %}
        <div class="content-block">
          <div class="content-header">
            <div>
              <h2>Planning Tools</h2>
              <p class="muted">Inputs that shape how planning is prioritized.</p>
            </div>
          </div>

          <div class="card-widget compact">
            <div class="panel-header">
              <div class="panel-title">
                <h3>Strategic Customers</h3>
              </div>
            </div>
            <div class="panel-body">
              <p class="muted">Strategic customers appear at the top of the Orders grid (first 5 shown, expandable).</p>
              <p class="muted">Format: one per line. Use <code>Label|PATTERN1,PATTERN2</code> (case-insensitive substring matches).</p>
              <form class="form-grid" method="post" action="{{ url_for('save_planning_tools') }}">
                <label style="grid-column: 1 / -1;">
                  Definitions
                  <textarea name="strategic_customers" rows="6" {% if not is_admin %}disabled{% endif %}>{{ strategic_customers_raw or '' }}</textarea>
                </label>
                <div class="form-actions" style="grid-column: 1 / -1;">
                  {% if is_admin %}
                    <button class="btn-success" type="submit">Save</button>
                  {% else %}
                    <div class="readonly-note">Planning tools are read-only for planners.</div>
                  {% endif %}
                </div>
              </form>

              {% if strategic_customers and strategic_customers | length %}
                <div class="section-divider"></div>
                <div class="meta-label">Preview</div>
                <div style="display:grid; gap: 6px; margin-top: 8px;">
                  {% for entry in strategic_customers %}
                    <div class="meta-chip"><strong>{{ entry.label }}</strong>  {{ entry.patterns | join(', ') }}</div>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </div>

          <div class="card-widget compact">
            <div class="panel-header">
              <div class="panel-title">
                <h3>Optimizer Defaults</h3>
              </div>
            </div>
            <div class="panel-body">
              <p class="muted">These defaults are used when generating draft loads.</p>
              <div class="table-container">
                <table class="settings-table">
                  <thead>
                    <tr>
                      <th>Parameter</th>
                      <th>Default</th>
                      <th>Notes</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>Trailer Type</td>
                      <td>{{ optimizer_defaults.trailer_type or 'STEP_DECK' }}</td>
                      <td>Trailer profile used for stacking + capacity.</td>
                    </tr>
                    <tr>
                      <td>Capacity (ft)</td>
                      <td>{{ optimizer_defaults.capacity_feet or 53 }}</td>
                      <td>Target trailer length capacity used for utilization.</td>
                    </tr>
                    <tr>
                      <td>Time Window (days)</td>
                      <td>{{ optimizer_defaults.time_window_days or 7 }}</td>
                      <td>Orders may be batched up to this many days early.</td>
                    </tr>
                    <tr>
                      <td>Geo Radius (mi)</td>
                      <td>{{ optimizer_defaults.geo_radius or 100 }}</td>
                      <td>Controls geographic clustering of stops.</td>
                    </tr>
                    <tr>
                      <td>Max Detour (%)</td>
                      <td>{{ optimizer_defaults.max_detour_pct or 15 }}</td>
                      <td>Limit used when evaluating route compatibility.</td>
                    </tr>
                    <tr>
                      <td>Stack Overflow Max Height</td>
                      <td>{{ optimizer_defaults.stack_overflow_max_height or 5 }}</td>
                      <td>Enables one overflow unit on full stacks (0 disables).</td>
                    </tr>
                    <tr>
                      <td>Back Overhang Allowance (ft)</td>
                      <td>{{ optimizer_defaults.max_back_overhang_ft or 4 }}</td>
                      <td>Allowed trailer-back overhang before capacity is treated as exceeded.</td>
                    </tr>
                    <tr>
                      <td>Upper Deck Two-Across Max Length (ft)</td>
                      <td>{{ optimizer_defaults.upper_two_across_max_length_ft or 7 }}</td>
                      <td>Step deck upper-deck stacks at or below this length can be modeled 2-across. Upper deck stack height still follows flatbed max-stack per SKU.</td>
                    </tr>
                    <tr>
                      <td>Upper Deck Exception Max Length (ft)</td>
                      <td>{{ optimizer_defaults.upper_deck_exception_max_length_ft or 16 }}</td>
                      <td>Selected categories can be placed on the upper deck up to this length.</td>
                    </tr>
                    <tr>
                      <td>Upper Deck Exception Overhang Allowance (ft)</td>
                      <td>{{ optimizer_defaults.upper_deck_exception_overhang_allowance_ft or 6 }}</td>
                      <td>Allowed upper-deck overhang for exception-eligible stacks.</td>
                    </tr>
                    <tr>
                      <td>Upper Deck Exception Categories</td>
                      <td>{{ (optimizer_defaults.upper_deck_exception_categories or ['USA', 'UTA']) | join(', ') }}</td>
                      <td>Exception applies only to stacks where all categories are in this list.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="card-widget compact">
            <div class="panel-header">
              <div class="panel-title">
                <h3>Utilization Grade Thresholds</h3>
              </div>
            </div>
            <div class="panel-body">
              <p class="muted">Load grades are based on trailer utilization percent.</p>
              <div class="table-container">
                <table class="settings-table">
                  <thead>
                    <tr>
                      <th>Grade</th>
                      <th>Threshold</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in util_grade_thresholds %}
                      <tr>
                        <td><span class="badge badge-grade util-{{ row.grade | lower }}">Grade {{ row.grade }}</span></td>
                        <td>{{ row.label }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </section>
  {% if is_admin %}
    <script>
      (function () {
        const tab = "{{ tab }}";

        function parseValue(value, type) {
          if (type === 'int') {
            const parsed = parseInt(value, 10);
            return Number.isNaN(parsed) ? 0 : parsed;
          }
          if (type === 'float') {
            const parsed = parseFloat(value);
            return Number.isNaN(parsed) ? 0 : parsed;
          }
          return value;
        }

        function attachInlineSaver(tableId) {
          const table = document.getElementById(tableId);
          if (!table) return;
          const saveUrl = table.dataset.save;
          const inputs = table.querySelectorAll('[data-field]');
          const saveTimers = new WeakMap();

          async function persistRow(triggerInput, revertOnFailure = true) {
            const row = triggerInput.closest('tr');
            if (!row) return;
            const fields = row.querySelectorAll('[data-field]');
            const hasChange = Array.from(fields).some((field) => field.value !== field.dataset.current);
            if (!hasChange) return;

            const payload = { id: row.dataset.id };
            fields.forEach((field) => {
              payload[field.dataset.field] = parseValue(field.value, field.dataset.type);
            });

            try {
              const response = await fetch(saveUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
              });
              if (!response.ok) throw new Error(`Save failed: ${response.status}`);
              fields.forEach((field) => {
                field.dataset.current = field.value;
              });
            } catch (error) {
              if (revertOnFailure) {
                fields.forEach((field) => {
                  field.value = field.dataset.current;
                });
              }
            }
          }

          inputs.forEach((input) => {
            input.dataset.current = input.value;
            if (input.tagName === 'SELECT') {
              input.addEventListener('change', async () => {
                await persistRow(input);
              });
              return;
            }

            input.addEventListener('blur', async () => {
              await persistRow(input);
            });

            input.addEventListener('input', () => {
              const existingTimer = saveTimers.get(input);
              if (existingTimer) clearTimeout(existingTimer);
              const timer = setTimeout(() => {
                persistRow(input, false);
              }, 700);
              saveTimers.set(input, timer);
            });

            input.addEventListener('keydown', (event) => {
              if (event.key === 'Enter') {
                event.preventDefault();
                input.blur();
              }
            });
          });
        }

        function setupRateContextTabs() {
          const shell = document.getElementById('rate-context-shell');
          if (!shell) return;

          const tabs = Array.from(shell.querySelectorAll('[data-rate-context-target]'));
          const panels = Array.from(shell.querySelectorAll('[data-rate-context-panel]'));

          const activateTab = (target) => {
            tabs.forEach((tab) => {
              const active = tab.dataset.rateContextTarget === target;
              tab.classList.toggle('is-active', active);
              tab.setAttribute('aria-selected', active ? 'true' : 'false');
            });
            panels.forEach((panel) => {
              const active = panel.dataset.rateContextPanel === target;
              panel.classList.toggle('is-active', active);
              panel.hidden = !active;
            });
          };

          tabs.forEach((tab) => {
            tab.addEventListener('click', () => {
              activateTab(tab.dataset.rateContextTarget || 'default');
            });
          });
        }

        function setupRatesMatrix() {
          const table = document.getElementById('rates-matrix');
          const statusEl = document.getElementById('rates-status');
          const searchInput = document.getElementById('rate-search');
          const surchargeInput = document.getElementById('fuel-surcharge-input');
          const surchargeNote = document.getElementById('fuel-surcharge-note');

          function updateSurchargeNote(value) {
            if (!surchargeNote) return;
            const base = 3.25;
            surchargeNote.textContent = `Applied per mile. Example: base $${base.toFixed(2)} -> effective $${(base + value).toFixed(2)}`;
          }

          if (searchInput && table) {
            searchInput.addEventListener('input', () => {
              const term = searchInput.value.toLowerCase().trim();
              table.querySelectorAll('tbody tr').forEach((row) => {
                const haystack = row.textContent.toLowerCase();
                row.style.display = haystack.includes(term) ? '' : 'none';
              });
            });
          }

          if (table) {
            table.querySelectorAll('.rate-input').forEach((input) => {
              input.dataset.current = input.value;

              input.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                  event.preventDefault();
                  input.blur();
                }
              });

              input.addEventListener('blur', async () => {
                if (input.value === input.dataset.current) return;
                const cell = input.closest('.rate-cell');
                if (!cell) return;
                const rateId = cell.dataset.rateId || undefined;
                const origin = cell.dataset.originPlant || '';
                const destination = cell.dataset.destinationState || '';
                const year = cell.dataset.effectiveYear || 2026;
                const parsed = parseFloat(input.value);

                if (Number.isNaN(parsed)) {
                  input.value = input.dataset.current || '';
                  return;
                }

                if (statusEl) statusEl.textContent = 'Saving...';

                try {
                  const response = await fetch('/rates/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      id: rateId,
                      origin_plant: origin,
                      destination_state: destination,
                      rate_per_mile: parsed,
                      effective_year: year,
                    }),
                  });
                  const data = await response.json();
                  if (data && data.rate) {
                    cell.dataset.rateId = data.rate.id || '';
                    cell.dataset.effectiveYear = data.rate.effective_year || year;
                    input.value = Number(data.rate.rate_per_mile || parsed).toFixed(2);
                  } else {
                    input.value = parsed.toFixed(2);
                  }
                  input.dataset.current = input.value;
                  if (statusEl) statusEl.textContent = 'Saved.';
                } catch (error) {
                  input.value = input.dataset.current || '';
                  if (statusEl) statusEl.textContent = 'Unable to save.';
                }
              });
            });
          }

          if (surchargeInput) {
            surchargeInput.dataset.current = surchargeInput.value;
            updateSurchargeNote(parseFloat(surchargeInput.value || '0') || 0);

            surchargeInput.addEventListener('keydown', (event) => {
              if (event.key === 'Enter') {
                event.preventDefault();
                surchargeInput.blur();
              }
            });

            surchargeInput.addEventListener('blur', async () => {
              if (surchargeInput.value === surchargeInput.dataset.current) return;
              const parsed = parseFloat(surchargeInput.value);
              if (Number.isNaN(parsed) || parsed < 0) {
                surchargeInput.value = surchargeInput.dataset.current || '0.40';
                return;
              }
              if (statusEl) statusEl.textContent = 'Saving...';
              try {
                const response = await fetch('/rates/fuel-surcharge/save', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ fuel_surcharge_per_mile: parsed }),
                });
                const data = await response.json();
                const saved = Number(data.fuel_surcharge_per_mile || parsed);
                surchargeInput.value = saved.toFixed(2);
                surchargeInput.dataset.current = surchargeInput.value;
                updateSurchargeNote(saved);
                if (statusEl) statusEl.textContent = 'Saved.';
              } catch (error) {
                surchargeInput.value = surchargeInput.dataset.current || '0.40';
                if (statusEl) statusEl.textContent = 'Unable to save.';
              }
            });
          }
        }

        function setupStrategicEditor() {
          const form = document.getElementById('strategic-customers-form');
          if (!form) return;
          const rowsHost = form.querySelector('[data-strategic-rows]');
          const hiddenField = form.querySelector('[data-strategic-hidden]');
          const addButton = form.querySelector('[data-strategic-add]');
          const chipList = document.querySelector('[data-strategic-chip-list]');

          if (!rowsHost || !hiddenField) return;

          function createRow({
            label = '',
            patterns = '',
            defaultDueDateFlexDays = null,
            noMix = false,
            defaultWedge = false,
            requiresReturnTrip = false,
            ignoreForOptimization = false,
            includeInOptimizerWorkbench = true,
          } = {}) {
            const row = document.createElement('tr');
            row.className = 'strategic-row';
            row.setAttribute('data-strategic-row', '');
            row.innerHTML = `
              <td>
                <input class="table-input" type="text" data-strategic-label placeholder="Customer label" value="${label}">
              </td>
              <td>
                <input class="table-input strategic-pattern-input" type="text" data-strategic-patterns placeholder="Pattern1, Pattern2" value="${patterns}">
              </td>
              <td>
                <input class="table-input strategic-flex-input" type="number" min="0" step="1" data-strategic-flex placeholder="Use Global" value="${defaultDueDateFlexDays === null || defaultDueDateFlexDays === undefined || defaultDueDateFlexDays === '' ? '' : Math.max(parseInt(defaultDueDateFlexDays, 10) || 0, 0)}">
              </td>
              <td class="strategic-check-cell">
                <input class="strategic-checkbox" type="checkbox" data-strategic-no-mix ${noMix ? 'checked' : ''}>
              </td>
              <td class="strategic-check-cell">
                <input class="strategic-checkbox" type="checkbox" data-strategic-wedge ${defaultWedge ? 'checked' : ''}>
              </td>
              <td class="strategic-check-cell">
                <input class="strategic-checkbox" type="checkbox" data-strategic-return ${requiresReturnTrip ? 'checked' : ''}>
              </td>
              <td class="strategic-check-cell">
                <input class="strategic-checkbox" type="checkbox" data-strategic-ignore-opt ${ignoreForOptimization ? 'checked' : ''}>
              </td>
              <td class="strategic-check-cell">
                <input class="strategic-checkbox" type="checkbox" data-strategic-workbench ${includeInOptimizerWorkbench ? 'checked' : ''}>
              </td>
              <td class="strategic-remove-cell">
                <button class="btn-ghost btn-icon" type="button" data-strategic-remove title="Remove row">
                  <span class="material-symbols-outlined">close</span>
                </button>
              </td>
            `;
            return row;
          }

          function collectRows() {
            return Array.from(rowsHost.querySelectorAll('[data-strategic-row]'))
              .map((row) => {
                const label = (row.querySelector('[data-strategic-label]')?.value || '').trim();
                const patternsRaw = (row.querySelector('[data-strategic-patterns]')?.value || '').trim();
                const patterns = patternsRaw
                  .split(',')
                  .map((item) => item.trim())
                  .filter(Boolean);
                const rawFlex = (row.querySelector('[data-strategic-flex]')?.value || '').trim();
                const parsedFlex = parseInt(rawFlex, 10);
                const default_due_date_flex_days = rawFlex === '' || Number.isNaN(parsedFlex)
                  ? null
                  : Math.max(parsedFlex, 0);
                const no_mix = !!row.querySelector('[data-strategic-no-mix]')?.checked;
                const default_wedge_51 = !!row.querySelector('[data-strategic-wedge]')?.checked;
                const requires_return_to_origin = !!row.querySelector('[data-strategic-return]')?.checked;
                const ignore_for_optimization = !!row.querySelector('[data-strategic-ignore-opt]')?.checked;
                const include_in_optimizer_workbench = !!row.querySelector('[data-strategic-workbench]')?.checked;
                return {
                  label,
                  patterns,
                  default_due_date_flex_days,
                  no_mix,
                  default_wedge_51,
                  requires_return_to_origin,
                  ignore_for_optimization,
                  include_in_optimizer_workbench,
                };
              })
              .filter((entry) => entry.label && entry.patterns.length);
          }

          function renderChips(entries) {
            if (!chipList) return;
            chipList.innerHTML = '';
            entries.forEach((entry) => {
              const chip = document.createElement('span');
              chip.className = 'meta-chip strategic-chip';
              const strong = document.createElement('strong');
              strong.textContent = entry.label;
              chip.appendChild(strong);
              const tags = [];
              if (entry.default_due_date_flex_days !== null && entry.default_due_date_flex_days !== undefined) {
                tags.push(`Flex ${entry.default_due_date_flex_days}d`);
              }
              if (entry.no_mix) tags.push('No Mix');
              if (entry.default_wedge_51) tags.push("51' Wedge");
              if (entry.requires_return_to_origin) tags.push('Return Trip');
              if (entry.ignore_for_optimization) tags.push('Ignored in Auto Optimize');
              if (!entry.include_in_optimizer_workbench) tags.push('Hidden in Workbench');
              const tagText = tags.length ? ` - ${tags.join(' | ')}` : '';
              chip.append(` - ${entry.patterns.join(', ')}${tagText}`);
              chipList.appendChild(chip);
            });
          }

          function syncHiddenField() {
            const entries = collectRows();
            hiddenField.value = JSON.stringify(entries);
            renderChips(entries);
          }

          if (addButton) {
            addButton.addEventListener('click', () => {
              rowsHost.appendChild(createRow());
            });
          }

          rowsHost.addEventListener('click', (event) => {
            const removeButton = event.target.closest('[data-strategic-remove]');
            if (!removeButton) return;
            const row = removeButton.closest('[data-strategic-row]');
            if (!row) return;
            row.remove();
            if (!rowsHost.querySelector('[data-strategic-row]')) {
              rowsHost.appendChild(createRow());
            }
            syncHiddenField();
          });

          rowsHost.addEventListener('input', (event) => {
            if (event.target.matches('[data-strategic-label], [data-strategic-patterns], [data-strategic-flex], [data-strategic-no-mix], [data-strategic-wedge], [data-strategic-return], [data-strategic-ignore-opt], [data-strategic-workbench]')) {
              syncHiddenField();
            }
          });

          rowsHost.addEventListener('change', (event) => {
            if (event.target.matches('[data-strategic-no-mix], [data-strategic-wedge], [data-strategic-return], [data-strategic-ignore-opt], [data-strategic-workbench]')) {
              syncHiddenField();
            }
          });

          form.addEventListener('submit', () => {
            syncHiddenField();
          });

          syncHiddenField();
        }

        function setupUtilGradeSync() {
          const dInput = document.querySelector('[data-grade-d-input]');
          const fInput = document.querySelector('[data-grade-f-input]');
          if (!dInput || !fInput) return;

          let mute = false;
          const clamp = (value, min, max) => {
            const parsed = parseInt(value, 10);
            if (Number.isNaN(parsed)) return min;
            return Math.min(max, Math.max(min, parsed));
          };

          dInput.addEventListener('input', () => {
            if (mute) return;
            mute = true;
            const d = clamp(dInput.value, 0, 100);
            dInput.value = d;
            fInput.value = Math.max(d - 1, 0);
            mute = false;
          });

          fInput.addEventListener('input', () => {
            if (mute) return;
            mute = true;
            const f = clamp(fInput.value, 0, 99);
            fInput.value = f;
            dInput.value = Math.min(f + 1, 100);
            mute = false;
          });
        }

        function setupStopColorEditor() {
          const form = document.getElementById('stop-colors-form');
          if (!form) return;
          const rows = Array.from(form.querySelectorAll('[data-stop-color-row]'));
          if (!rows.length) return;

          const normalizeHex = (value) => {
            let text = String(value || '').trim().toUpperCase();
            if (!text) return '';
            if (!text.startsWith('#')) text = `#${text}`;
            return /^#[0-9A-F]{6}$/.test(text) ? text : '';
          };

          rows.forEach((row) => {
            const colorInput = row.querySelector('[data-stop-color-input]');
            const hexInput = row.querySelector('[data-stop-color-hex]');
            const swatch = row.querySelector('[data-stop-color-swatch]');
            if (!colorInput || !hexInput || !swatch) return;

            const syncFromColor = () => {
              const normalized = normalizeHex(colorInput.value) || '#000000';
              colorInput.value = normalized.toLowerCase();
              hexInput.value = normalized;
              swatch.style.setProperty('--stop-color', normalized);
            };
            const syncFromHex = () => {
              const normalized = normalizeHex(hexInput.value);
              if (!normalized) return false;
              colorInput.value = normalized.toLowerCase();
              hexInput.value = normalized;
              swatch.style.setProperty('--stop-color', normalized);
              return true;
            };

            colorInput.addEventListener('input', syncFromColor);
            colorInput.addEventListener('change', syncFromColor);
            hexInput.addEventListener('blur', () => {
              if (!syncFromHex()) syncFromColor();
            });
            hexInput.addEventListener('change', () => {
              if (!syncFromHex()) syncFromColor();
            });
            syncFromColor();
          });

          form.addEventListener('submit', () => {
            rows.forEach((row) => {
              const colorInput = row.querySelector('[data-stop-color-input]');
              const hexInput = row.querySelector('[data-stop-color-hex]');
              if (!colorInput || !hexInput) return;
              const normalized = normalizeHex(hexInput.value);
              if (normalized) {
                colorInput.value = normalized.toLowerCase();
                hexInput.value = normalized;
              } else {
                hexInput.value = normalizeHex(colorInput.value) || '#000000';
              }
            });
          });
        }


        if (tab === 'rates') {
          setupRateContextTabs();
          setupRatesMatrix();
        }
        if (tab === 'overview') {
          setupStrategicEditor();
          setupUtilGradeSync();
          setupStopColorEditor();
          attachInlineSaver('overview-sku-table');
          attachInlineSaver('overview-plants-table');
        }
        if (tab === 'skus') attachInlineSaver('sku-table');
        if (tab === 'lookups') attachInlineSaver('lookup-table');
        if (tab === 'plants') attachInlineSaver('plants-table');
      })();
    </script>
  {% endif %}
  <script>
    (function () {
      const tab = "{{ tab }}";
      if (tab === 'rates') return;
      if (tab !== 'skus') return;
      const addSkuToggle = document.querySelector('[data-sku-add-toggle]');
      const addSkuPanel = document.getElementById('sku-add-form-panel');
      const syncAddSkuToggle = () => {
        if (!addSkuToggle || !addSkuPanel) return;
        const expanded = !addSkuPanel.hidden;
        addSkuToggle.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        addSkuToggle.textContent = expanded ? 'Hide Add SKU' : 'Add SKU';
      };

      if (addSkuToggle && addSkuPanel) {
        syncAddSkuToggle();
        addSkuToggle.addEventListener('click', () => {
          addSkuPanel.hidden = !addSkuPanel.hidden;
          syncAddSkuToggle();
        });
      }

      const sourceTable = document.getElementById('source-led-table');
      const sourceSearchInput = document.querySelector('[data-source-led-search]');
      const sourceColumnToggle = document.querySelector('[data-source-column-toggle]');
      if (sourceTable && sourceSearchInput) {
        const sourceExtraColumns = Array.from(sourceTable.querySelectorAll('[data-source-extra-col]'));
        const sourceRows = Array.from(sourceTable.querySelectorAll('tbody tr[data-source-row]'));
        const normalizeSource = (value) => (value || '').trim().toUpperCase();
        const setSourceColumnsVisible = (visible) => {
          sourceExtraColumns.forEach((cell) => {
            cell.hidden = !visible;
          });
          if (sourceColumnToggle) {
            sourceColumnToggle.setAttribute('aria-expanded', visible ? 'true' : 'false');
            sourceColumnToggle.textContent = visible ? '- Columns' : '+ Columns';
            sourceColumnToggle.title = visible ? 'Hide mapping columns' : 'Show mapping columns';
          }
        };

        if (sourceColumnToggle) {
          sourceColumnToggle.addEventListener('click', () => {
            const expanded = sourceColumnToggle.getAttribute('aria-expanded') === 'true';
            setSourceColumnsVisible(!expanded);
          });
        }

        const applySourceSearch = () => {
          const term = normalizeSource(sourceSearchInput.value);
          sourceRows.forEach((row) => {
            const haystack = [
              row.dataset.itemNum || '',
              row.dataset.itemDesc || '',
              row.dataset.mappedSku || '',
              row.dataset.category || '',
            ]
              .map((value) => normalizeSource(value))
              .join(' ');
            row.style.display = !term || haystack.includes(term) ? '' : 'none';
          });
        };
        sourceSearchInput.addEventListener('input', applySourceSearch);
        setSourceColumnsVisible(false);
        applySourceSearch();
      } else if (sourceColumnToggle) {
        sourceColumnToggle.disabled = true;
      }

      const table = document.getElementById('sku-table');
      if (!table) return;
      const searchInput = document.querySelector('[data-sku-search]');
      const lengthSelect = document.querySelector('[data-sku-length-filter]');
      const stepSelect = document.querySelector('[data-sku-step-filter]');
      const categorySelect = document.querySelector('[data-sku-category-filter]');
      const flatSelect = document.querySelector('[data-sku-flat-filter]');
      const resetButton = document.querySelector('[data-sku-filter-reset]');
      const rows = Array.from(table.querySelectorAll('tbody tr[data-sku-row]'));
      const groupRows = Array.from(table.querySelectorAll('tbody tr[data-sku-group]'));

      const normalize = (value) => (value || '').trim().toUpperCase();
      const normalizeNumeric = (value) => {
        if (value === null || value === undefined || value === '') return '';
        const parsed = Number.parseFloat(value);
        if (Number.isNaN(parsed)) return '';
        return String(parsed);
      };
      const readFieldValue = (row, fieldName, fallbackValue = '') => {
        const input = row.querySelector(`[data-field="${fieldName}"]`);
        if (!input) return fallbackValue;
        return input.value || '';
      };

      const applyFilters = () => {
        const searchTerm = normalize(searchInput ? searchInput.value : '');
        const lengthValue = normalizeNumeric(lengthSelect ? lengthSelect.value : '');
        const stepValue = normalizeNumeric(stepSelect ? stepSelect.value : '');
        const category = normalize(categorySelect ? categorySelect.value : '');
        const flatValue = normalizeNumeric(flatSelect ? flatSelect.value : '');

        rows.forEach((row) => {
          let visible = true;
          const rowSku = normalize(readFieldValue(row, 'sku', row.dataset.skuValue || ''));
          const rowDescription = normalize(readFieldValue(row, 'description', row.dataset.descriptionValue || ''));
          const rowCategory = normalize(readFieldValue(row, 'category', row.dataset.categoryValue || ''));
          const rowLength = normalizeNumeric(
            readFieldValue(row, 'length_with_tongue_ft', row.dataset.lengthValue || '')
          );
          const rowStepDeck = normalizeNumeric(
            readFieldValue(row, 'max_stack_step_deck', row.dataset.stepDeckValue || '')
          );
          const rowFlatBed = normalizeNumeric(
            readFieldValue(row, 'max_stack_flat_bed', row.dataset.flatBedValue || '')
          );

          if (searchTerm && !rowSku.includes(searchTerm) && !rowDescription.includes(searchTerm)) {
            visible = false;
          }
          if (visible && lengthValue && rowLength !== lengthValue) {
            visible = false;
          }
          if (visible && stepValue && rowStepDeck !== stepValue) {
            visible = false;
          }
          if (category && rowCategory !== category) {
            visible = false;
          }
          if (visible && flatValue && rowFlatBed !== flatValue) {
            visible = false;
          }

          row.style.display = visible ? '' : 'none';
        });

        groupRows.forEach((groupRow) => {
          const group = groupRow.dataset.skuGroup || '';
          const hasVisible = rows.some(
            (row) =>
              row.dataset.origin === group && row.style.display !== 'none'
          );
          groupRow.style.display = hasVisible ? '' : 'none';
        });
      };

      [searchInput, lengthSelect, stepSelect, categorySelect, flatSelect].forEach((input) => {
        if (!input) return;
        input.addEventListener('change', applyFilters);
        input.addEventListener('input', applyFilters);
      });

      if (resetButton) {
        resetButton.addEventListener('click', () => {
          if (searchInput) searchInput.value = '';
          if (lengthSelect) lengthSelect.value = '';
          if (stepSelect) stepSelect.value = '';
          if (categorySelect) categorySelect.value = '';
          if (flatSelect) flatSelect.value = '';
          applyFilters();
        });
      }

      applyFilters();
    })();
  </script>
{% endblock %}

